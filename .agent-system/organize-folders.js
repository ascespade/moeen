#!/usr/bin/env node
/**
 * üìÅ Organize Folders - ÿ™ŸÜÿ∏ŸäŸÖ ÿ¢ŸÖŸÜ ŸÑŸÑŸÖÿ¨ŸÑÿØÿßÿ™
 * ŸäŸÜÿ∏ŸÖ ŸáŸäŸÉŸÑ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàŸäÿ∂ÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä ŸÖÿ¨ŸÑÿØÿßÿ™Ÿáÿß ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log('\nüìÅ Organize Folders Agent Starting...\n');
console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

const BACKUP_DIR = 'tmp/backup-folders-' + Date.now();
const LOG_FILE = 'tmp/organize-folders.log';

function log(message, level = 'info') {
  const timestamp = new Date().toISOString();
  const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
  console.log(logMessage);
  
  try {
    fs.appendFileSync(LOG_FILE, logMessage + '\n');
  } catch (err) {
    // Ignore
  }
}

// ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
function createBackup() {
  log('Creating backup...', 'info');
  try {
    execSync(`mkdir -p ${BACKUP_DIR}`, { stdio: 'inherit' });
    execSync(`cp -r src ${BACKUP_DIR}/src`, { stdio: 'inherit' });
    log(`‚úÖ Backup created at ${BACKUP_DIR}`, 'success');
    return true;
  } catch (error) {
    log(`‚ùå Backup failed: ${error.message}`, 'error');
    return false;
  }
}

// ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑŸÄ components
function organizeComponents() {
  log('\nüì¶ Organizing components...', 'info');
  
  const componentsDir = 'src/components';
  let organized = 0;
  
  try {
    // ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿßŸÑŸÖŸàÿµŸâ ÿ®Ÿáÿß
    const categories = {
      'ui': ['Button', 'Input', 'Modal', 'Card', 'Badge', 'Alert', 'Spinner', 'Toast'],
      'forms': ['Form', 'Field', 'Select', 'Checkbox', 'Radio', 'DatePicker'],
      'layout': ['Header', 'Footer', 'Sidebar', 'Navigation', 'Container'],
      'common': ['Loading', 'Error', 'Empty', 'NotFound'],
      'auth': ['Login', 'Register', 'ForgotPassword', 'ResetPassword'],
      'admin': ['AdminPanel', 'Dashboard', 'Stats'],
      'patient': ['PatientCard', 'PatientList', 'PatientProfile'],
      'booking': ['BookingForm', 'Calendar', 'TimeSlot', 'SessionType'],
      'chatbot': ['Chatbot', 'Message', 'ChatInput']
    };
    
    // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
    if (fs.existsSync(componentsDir)) {
      const files = fs.readdirSync(componentsDir);
      
      for (const file of files) {
        const filePath = path.join(componentsDir, file);
        const stats = fs.statSync(filePath);
        
        // ÿ™ÿÆÿ∑Ÿä ÿßŸÑŸÖÿ¨ŸÑÿØÿßÿ™
        if (stats.isDirectory()) continue;
        
        // ÿ™ÿÆÿ∑Ÿä ÿ∫Ÿäÿ± TSX/JSX
        if (!file.endsWith('.tsx') && !file.endsWith('.jsx')) continue;
        
        // ÿ•Ÿäÿ¨ÿßÿØ ÿßŸÑŸÅÿ¶ÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©
        let targetCategory = 'common';
        const componentName = file.replace(/\.(tsx|jsx)$/, '');
        
        for (const [category, keywords] of Object.entries(categories)) {
          if (keywords.some(keyword => componentName.includes(keyword))) {
            targetCategory = category;
            break;
          }
        }
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ¨ŸÑÿØ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
        const targetDir = path.join(componentsDir, targetCategory);
        if (!fs.existsSync(targetDir)) {
          fs.mkdirSync(targetDir, { recursive: true });
        }
        
        // ŸÜŸÇŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÅŸä ŸÖŸÉÿßŸÜ ÿÆÿßÿ∑ÿ¶
        const targetPath = path.join(targetDir, file);
        if (filePath !== targetPath && !fs.existsSync(targetPath)) {
          fs.renameSync(filePath, targetPath);
          log(`   ‚úÖ Moved: ${file} ‚Üí ${targetCategory}/`, 'success');
          organized++;
        }
      }
    }
    
    log(`\n   Organized ${organized} components\n`, 'info');
    return organized;
    
  } catch (error) {
    log(`   ‚ùå Error organizing components: ${error.message}`, 'error');
    return 0;
  }
}

// ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑŸÄ lib
function organizeLib() {
  log('üìö Organizing lib...', 'info');
  
  const libDir = 'src/lib';
  let organized = 0;
  
  try {
    // ÿßŸÑŸÖÿ¨ŸÑÿØÿßÿ™ ÿßŸÑŸÖŸàÿµŸâ ÿ®Ÿáÿß
    const recommendedFolders = [
      'api',           // API clients
      'auth',          // Authentication
      'hooks',         // Custom hooks
      'utils',         // Utility functions
      'constants',     // Constants
      'types',         // TypeScript types
      'config',        // Configuration
      'validations',   // Validation schemas
      'helpers',       // Helper functions
      'services',      // Business logic
      'supabase',      // Supabase client
      'monitoring',    // Logging & monitoring
      'notifications', // Notifications
      'integrations'   // Third-party integrations
    ];
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ¨ŸÑÿØÿßÿ™ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿ©
    for (const folder of recommendedFolders) {
      const folderPath = path.join(libDir, folder);
      if (!fs.existsSync(folderPath)) {
        fs.mkdirSync(folderPath, { recursive: true });
        log(`   ‚úÖ Created: lib/${folder}/`, 'success');
        organized++;
      }
    }
    
    log(`\n   Organized ${organized} lib folders\n`, 'info');
    return organized;
    
  } catch (error) {
    log(`   ‚ùå Error organizing lib: ${error.message}`, 'error');
    return 0;
  }
}

// ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
function findDuplicates() {
  log('üîç Finding duplicate files...', 'info');
  
  const duplicates = [];
  const fileHashes = {};
  
  try {
    // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä src
    const findFiles = (dir) => {
      const files = fs.readdirSync(dir);
      
      for (const file of files) {
        const filePath = path.join(dir, file);
        const stats = fs.statSync(filePath);
        
        if (stats.isDirectory()) {
          // ÿ™ÿÆÿ∑Ÿä node_modules Ÿà .next Ÿà .git
          if (!['node_modules', '.next', '.git', 'tmp'].includes(file)) {
            findFiles(filePath);
          }
        } else if (file.endsWith('.ts') || file.endsWith('.tsx')) {
          const content = fs.readFileSync(filePath, 'utf8');
          const size = stats.size;
          const key = `${file}-${size}`;
          
          if (fileHashes[key]) {
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
            const existingContent = fs.readFileSync(fileHashes[key], 'utf8');
            if (content === existingContent) {
              duplicates.push({
                file1: fileHashes[key],
                file2: filePath
              });
            }
          } else {
            fileHashes[key] = filePath;
          }
        }
      }
    };
    
    findFiles('src');
    
    if (duplicates.length > 0) {
      log(`\n   ‚ö†Ô∏è  Found ${duplicates.length} duplicate files:`, 'warn');
      duplicates.forEach(dup => {
        log(`      ${dup.file1}`, 'warn');
        log(`      ${dup.file2}`, 'warn');
        log('', 'info');
      });
    } else {
      log('   ‚úÖ No duplicates found', 'success');
    }
    
    return duplicates.length;
    
  } catch (error) {
    log(`   ‚ùå Error finding duplicates: ${error.message}`, 'error');
    return 0;
  }
}

// ÿ™ŸÜÿ∏ŸäŸÖ API routes
function organizeAPIRoutes() {
  log('\nüåê Organizing API routes...', 'info');
  
  const apiDir = 'src/app/api';
  let organized = 0;
  
  try {
    // ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÖŸàÿµŸâ ÿ®Ÿáÿß
    const categories = {
      'auth': ['login', 'register', 'logout', 'forgot-password', 'reset-password'],
      'users': ['users', 'profile'],
      'patients': ['patients'],
      'appointments': ['appointments', 'sessions'],
      'payments': ['payments', 'invoices'],
      'notifications': ['notifications', 'messages'],
      'admin': ['admin', 'settings'],
      'reports': ['reports', 'analytics']
    };
    
    if (fs.existsSync(apiDir)) {
      const routes = fs.readdirSync(apiDir);
      
      for (const route of routes) {
        const routePath = path.join(apiDir, route);
        const stats = fs.statSync(routePath);
        
        if (stats.isDirectory()) {
          // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
          let hasCategory = false;
          for (const category of Object.keys(categories)) {
            if (route.startsWith(category)) {
              hasCategory = true;
              break;
            }
          }
          
          if (!hasCategory) {
            log(`   ‚ö†Ô∏è  Uncategorized route: /api/${route}`, 'warn');
          }
        }
      }
    }
    
    log(`\n   Checked API routes organization\n`, 'info');
    return organized;
    
  } catch (error) {
    log(`   ‚ùå Error organizing API routes: ${error.message}`, 'error');
    return 0;
  }
}

// ÿ•ŸÜÿ¥ÿßÿ° index.ts files
function createIndexFiles() {
  log('üìÑ Creating index.ts files...', 'info');
  
  let created = 0;
  
  try {
    const dirs = [
      'src/components/ui',
      'src/components/forms',
      'src/components/layout',
      'src/lib/utils',
      'src/lib/hooks',
      'src/lib/helpers'
    ];
    
    for (const dir of dirs) {
      if (fs.existsSync(dir)) {
        const indexPath = path.join(dir, 'index.ts');
        
        if (!fs.existsSync(indexPath)) {
          // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
          const files = fs.readdirSync(dir).filter(f => 
            (f.endsWith('.ts') || f.endsWith('.tsx')) && f !== 'index.ts'
          );
          
          // ÿ•ŸÜÿ¥ÿßÿ° exports
          const exports = files.map(file => {
            const name = file.replace(/\.(ts|tsx)$/, '');
            return `export * from './${name}';`;
          }).join('\n');
          
          if (exports) {
            fs.writeFileSync(indexPath, exports + '\n');
            log(`   ‚úÖ Created: ${indexPath}`, 'success');
            created++;
          }
        }
      }
    }
    
    log(`\n   Created ${created} index files\n`, 'info');
    return created;
    
  } catch (error) {
    log(`   ‚ùå Error creating index files: ${error.message}`, 'error');
    return 0;
  }
}

// ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä
function generateReport(results) {
  log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
  log('\nüìä Folder Organization Report:\n', 'info');
  
  log(`   Components organized: ${results.components}`, 'info');
  log(`   Lib folders created: ${results.lib}`, 'info');
  log(`   Duplicate files found: ${results.duplicates}`, 'info');
  log(`   Index files created: ${results.indexFiles}`, 'info');
  
  const total = results.components + results.lib + results.indexFiles;
  log(`\n   Total actions: ${total}`, 'info');
  
  if (results.duplicates > 0) {
    log(`\n   ‚ö†Ô∏è  Please review duplicate files manually`, 'warn');
  }
  
  log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'info');
  
  // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
  const report = {
    timestamp: new Date().toISOString(),
    results,
    total
  };
  
  fs.writeFileSync('tmp/organize-folders-report.json', JSON.stringify(report, null, 2));
  log('üìÅ Report saved: tmp/organize-folders-report.json\n', 'info');
}

// ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
async function main() {
  const results = {
    components: 0,
    lib: 0,
    duplicates: 0,
    indexFiles: 0
  };
  
  try {
    // ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
    if (!createBackup()) {
      log('‚ùå Backup failed, aborting...', 'error');
      process.exit(1);
    }
    
    // ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™
    results.components = organizeComponents();
    
    // ÿ™ŸÜÿ∏ŸäŸÖ lib
    results.lib = organizeLib();
    
    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÉÿ±ÿ±ÿßÿ™
    results.duplicates = findDuplicates();
    
    // ÿ™ŸÜÿ∏ŸäŸÖ API routes
    organizeAPIRoutes();
    
    // ÿ•ŸÜÿ¥ÿßÿ° index files
    results.indexFiles = createIndexFiles();
    
    // ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
    generateReport(results);
    
    log('‚úÖ Folder organization complete!\n', 'success');
    process.exit(0);
    
  } catch (error) {
    log(`\n‚ùå Fatal error: ${error.message}`, 'error');
    process.exit(1);
  }
}

// ÿ™ÿ¥ÿ∫ŸäŸÑ
if (require.main === module) {
  main();
}

module.exports = { main };
