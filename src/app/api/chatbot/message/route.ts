import { NextRequest, NextResponse } from 'next/server';
import logger from '@/lib/monitoring/logger';

// Simple chatbot responses - ูููู ุชูุณูุนู ูุงุญูุงู
const responses: Record<string, string> = {
  // Greetings
  ูุฑุญุจุง: 'ุฃููุงู ูุณููุงู! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ',
  'ุงูุณูุงู ุนูููู': 'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ููู ุฃูุฏุฑ ุฃุฎุฏููุ',
  hi: 'Hello! How can I help you today?',

  // Appointments
  'ุงุญุฌุฒ ููุนุฏ':
    'ุฑุงุฆุน! ูุญุฌุฒ ููุนุฏุ ููููู:\n\n1๏ธโฃ ุงูุงุชุตุงู ุนูู: +966126173693\n2๏ธโฃ ูุงุชุณุงุจ: +966555381558\n3๏ธโฃ ุฃู ุนุจุฑ ูุธุงููุง ุงูุฅููุชุฑููู\n\nูุง ูู ุงูุชุฎุตุต ุงููุทููุจุ',
  ููุนุฏ: 'ูุญุฌุฒ ููุนุฏุ ุชูุงุตู ูุนูุง ุนูู:\n๐ +966126173693\n๐ฑ +966555381558',

  // Services
  ุงูุฎุฏูุงุช:
    'ุฎุฏูุงุชูุง ุงููุชุฎุตุตุฉ:\n\n๐ ุงูุชุดุฎูุต ูุงูุชูููู ุงูุดุงูู\n๐ฃ๏ธ ุนูุงุฌ ุงููุทู ูุงูุชุฎุงุทุจ\n๐ฏ ุงูุนูุงุฌ ุงููุธููู ูุงูุชูุงูู ุงูุญุณู\n๐งฉ ุชุนุฏูู ุงูุณููู (ABA)\n๐ ุงูุฏุนู ุงูููุณู ูุงูุฅุฑุดุงุฏ ุงูุฃุณุฑู\n๐ซ ุจุฑุงูุฌ ุงูุฑุนุงูุฉ ุงูููุงุฑูุฉ ูุงูุฏูุฌ\n\nุฃู ุฎุฏูุฉ ุชูููุ',
  'ูุง ูู ุงูุฎุฏูุงุช':
    'ุฎุฏูุงุชูุง ุชุดูู:\nโข ุงูุชุดุฎูุต ูุงูุชูููู\nโข ุนูุงุฌ ุงููุทู\nโข ุงูุนูุงุฌ ุงููุธููู\nโข ุชุนุฏูู ุงูุณููู\nโข ุงูุฏุนู ุงูุฃุณุฑู\nโข ุจุฑุงูุฌ ุงูุฏูุฌ',

  // Speech Therapy
  'ุนูุงุฌ ูุทู':
    'ุนูุงุฌ ุงููุทู ูุงูุชุฎุงุทุจ:\n\nโ ุนูุงุฌ ุงูุชูุนุซู ูุงููุฏุบุงุช\nโ ุชุฃุฎุฑ ุงููุทู\nโ ุงุถุทุฑุงุจุงุช ุงูุตูุช\nโ ุงูุชูุงุตู ุงูุจุฏูู (AAC)\n\nูุณุชุฎุฏู ูููุฌูุงุช PECS ูุชุญููู ุงูุณููู ุงูุชุทุจููู (ABA)',
  ุชุฎุงุทุจ:
    'ุฎุฏูุฉ ุงูุชุฎุงุทุจ ูุชููุฑุฉ ูุน ุฃุฎุตุงุฆููู ูุนุชูุฏูู. ุชูุงุตู ูุนูุง ูุญุฌุฒ ุฌูุณุฉ ุชูููู ูุฌุงููุฉ!',

  // Occupational Therapy
  'ุนูุงุฌ ูุธููู':
    'ุงูุนูุงุฌ ุงููุธููู ูุงูุชูุงูู ุงูุญุณู:\n\nโ ุชุญุณูู ุงูููุงุฑุงุช ุงูุญุฑููุฉ\nโ ุงูุงุนุชูุงุฏ ุนูู ุงูุฐุงุช\nโ ูุนุงูุฌุฉ ุงูุญุณุงุณูุงุช ุงูุญุณูุฉ\nโ ุบุฑู ุชูุงูู ุญุณู ูุชุฎุตุตุฉ',

  // ABA
  'ุชุนุฏูู ุณููู':
    'ุชุนุฏูู ุงูุณููู (ABA):\n\nโ ุฎุทุท ุณููููุฉ ูุฑุฏูุฉ (IEPs)\nโ ุชุนุฒูุฒ ุงูููุงุฑุงุช ุงูุงุฌุชูุงุนูุฉ\nโ ุงูุชุนุงูู ูุน ุงูุชุญุฏูุงุช ุงูุณููููุฉ\nโ ูููุฌูุงุช ูุจููุฉ ุนูู ุงูุฃุฏูุฉ',
  aba: 'ุจุฑูุงูุฌ ุชุญููู ุงูุณููู ุงูุชุทุจููู (ABA) ูุชููุฑ ูุน ุฃุฎุตุงุฆููู ูุนุชูุฏูู ุฏูููุงู',

  // Pricing
  ุงูุฃุณุนุงุฑ:
    'ููุงุณุชูุณุงุฑ ุนู ุงูุฃุณุนุงุฑ ูุงูุจุงูุงุช:\n\n๐ ุงุชุตู ุนูู: +966126173693\n๐ฑ ูุงุชุณุงุจ: +966555381558\n\nูุฏููุง ุจุงูุงุช ูุฎุตุตุฉ ุญุณุจ ุงูุญุงูุฉ ูุงูุงุญุชูุงุฌุงุช',
  'ูู ุงูุณุนุฑ':
    'ุงูุฃุณุนุงุฑ ุชุฎุชูู ุญุณุจ ููุน ุงูุฎุฏูุฉ. ุชูุงุตู ูุนูุง ููุญุตูู ุนูู ุนุฑุถ ุณุนุฑ ูุฎุตุต',

  // Location
  ุงููููุน:
    '๐ ูููุนูุง:\n\nุฌุฏุฉุ ุญู ุงูุตูุง\nุดุงุฑุน ุงูุฃููุฑ ูุญูุฏ ุจู ุนุจุฏ ุงูุนุฒูุฒ (ุงูุชุญููุฉ)\nููุฏู ุฏุจููู ุฅูู (WA Hotel) - ุงูุฏูุฑ ุงูุซุงูู\n\n๐ +966126173693',
  ุงูุนููุงู: 'ุฌุฏุฉ - ุญู ุงูุตูุง - ููุฏู WA - ุงูุฏูุฑ ุงูุซุงูู',

  // Working Hours
  'ุณุงุนุงุช ุงูุนูู':
    '๐ ุณุงุนุงุช ุงูุนูู:\n\nุงูุฃุญุฏ - ุงูุฎููุณ: 7 ุตุจุงุญุงู - 7 ูุณุงุกู\nุงูุฌูุนุฉ ูุงูุณุจุช: ูุบูู',
  'ูุชู ุชูุชุญูู': 'ูุนูู ุงูุฃุญุฏ - ุงูุฎููุณ ูู 7 ุตุจุงุญุงู ุญุชู 7 ูุณุงุกู',

  // Contact
  ุชูุงุตู:
    '๐ ุทุฑู ุงูุชูุงุตู:\n\nูุงุชู: +966126173693\nูุงุชุณุงุจ: +966555381558\nุจุฑูุฏ: info@alhemam.sa\nูููุน: http://alhemam.sa',
  ุงุชุตุงู: 'ููุชูุงุตู:\n๐ฑ ูุงุชุณุงุจ: +966555381558\n๐ ูุงุชู: +966126173693',

  // Emergency
  ุทูุงุฑุฆ:
    '๐จ ุฃุฑูุงู ุงูุทูุงุฑุฆ:\n\n997 - ุงูุทูุงุฑุฆ ุงูุนุงูุฉ\n911 - ุงูุฅุณุนุงู\n+966555381558 - ูุฑูุฒ ุงูููู (ูุงุชุณุงุจ)',
};

export async function POST(request: NextRequest) {
  try {
    const { message } = await request.json();

    if (!message || typeof message !== 'string') {
      return NextResponse.json({ error: 'Invalid message' }, { status: 400 });
    }

    // Normalize message
    const normalizedMessage = message.toLowerCase().trim();

    // Find best match
    let response =
      'ุนุฐุฑุงูุ ูู ุฃููู ุณุคุงูู ุจุดูู ูุงูู.\n\nููููู:\nโข ุงุชุตุงู: +966126173693\nโข ูุงุชุณุงุจ: +966555381558\nโข ุจุฑูุฏ: info@alhemam.sa\n\nุฃู ุฌุฑุจ ุฃู ุชุณุฃู ุนู:\n- ุงูุฎุฏูุงุช\n- ุญุฌุฒ ููุนุฏ\n- ุงูุฃุณุนุงุฑ\n- ุงููููุน';

    // Check for exact matches
    for (const [keyword, reply] of Object.entries(responses)) {
      if (normalizedMessage.includes(keyword.toLowerCase())) {
        response = reply;
        break;
      }
    }

    // Log interaction
    logger.info('Chatbot interaction', {
      message: message.substring(0, 100),
      responseType: response === responses['ูุฑุญุจุง'] ? 'greeting' : 'secondary',
    });

    return NextResponse.json({
      success: true,
      response,
    });
  } catch (error) {
    logger.error('Chatbot API error', error);

    return NextResponse.json(
      {
        success: false,
        response:
          'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ. ูุฑุฌู ุงูุชูุงุตู ูุนูุง ุนุจุฑ:\n๐ฑ ูุงุชุณุงุจ: +966555381558\n๐ ูุงุชู: +966126173693',
      },
      { status: 500 }
    );
  }
}
