name: ๐ค Smart Bootloader Agent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ุชุดุบูู ูู 6 ุณุงุนุงุช
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - fix-only
          - test-only
          - optimize-only
          - refactor

env:
  NODE_VERSION: '18'
  NPM_VERSION: '8'

jobs:
  # ๐ ูุญุต ุงูููุฏ
  code-analysis:
    name: ๐ ุชุญููู ุงูููุฏ
    runs-on: ubuntu-latest
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci
          npm install -g @typescript-eslint/parser @typescript-eslint/eslint-plugin

      - name: ๐ ูุญุต ESLint
        run: |
          echo "๐ ูุญุต ESLint..."
          npm run lint:check || echo "โ๏ธ ESLint ูุดู - ุณูุชู ุฅุตูุงุญู ุชููุงุฆููุง"

      - name: ๐ ูุญุต TypeScript
        run: |
          echo "๐ ูุญุต TypeScript..."
          npm run type:check || echo "โ๏ธ TypeScript ูุดู - ุณูุชู ุฅุตูุงุญู ุชููุงุฆููุง"

      - name: ๐ ูุญุต ุงูุฃูุงู
        run: |
          echo "๐ ูุญุต ุงูุฃูุงู..."
          npm run security:audit || echo "โ๏ธ ูุญุต ุงูุฃูุงู ูุดู"

      - name: ๐ ุชุญููู ุงูุฌูุฏุฉ
        run: |
          echo "๐ ุชุญููู ุฌูุฏุฉ ุงูููุฏ..."
          # ูููู ุฅุถุงูุฉ SonarQube ููุง

  # ๐งช ุงูุงุฎุชุจุงุฑุงุช
  testing:
    name: ๐งช ุงูุงุฎุชุจุงุฑุงุช
    runs-on: ubuntu-latest
    needs: code-analysis
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ
        if: matrix.test-type == 'unit'
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ..."
          npm run test:unit

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู
        if: matrix.test-type == 'integration'
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู..."
          npm run test:integration

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช E2E
        if: matrix.test-type == 'e2e'
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช E2E..."
          npm run test:e2e

      - name: ๐ ูุญุต ุงูุชุบุทูุฉ
        run: |
          echo "๐ ูุญุต ุชุบุทูุฉ ุงูุงุฎุชุจุงุฑุงุช..."
          npm run test:coverage

  # ๐ค ุงูู Agent ุงูุฐูู
  smart-agent:
    name: ๐ค ุงูู Agent ุงูุฐูู
    runs-on: ubuntu-latest
    needs: [code-analysis, testing]
    if: always()
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐ค ุชุดุบูู ุงูู Agent
        run: |
          echo "๐ค ุชุดุบูู Smart Bootloader Agent..."
          case "${{ github.event.inputs.mode || 'auto' }}" in
            "auto")
              npm run agent:auto
              ;;
            "fix-only")
              npm run agent:fix
              ;;
            "test-only")
              npm run agent:test
              ;;
            "optimize-only")
              npm run agent:optimize
              ;;
            "refactor")
              npm run agent:refactor
              ;;
            *)
              npm run agent:auto
              ;;
          esac

      - name: ๐ ุชุญุฏูุซ ุงูุชูุงุฑูุฑ
        run: |
          echo "๐ ุชุญุฏูุซ ุงูุชูุงุฑูุฑ..."
          # ุชุญุฏูุซ ุงูุชูุงุฑูุฑ ูุงููุซุงุฆู

      - name: ๐พ ุญูุธ ุงููุชุงุฆุฌ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-results-${{ github.run_number }}
          path: |
            log.system.md
            snapshot.version.json
            project.graph.md
          retention-days: 30

  # ๐ง ุงูุฅุตูุงุญ ุงูุชููุงุฆู
  auto-fix:
    name: ๐ง ุงูุฅุตูุงุญ ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: smart-agent
    if: failure() && github.event_name == 'push'
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐ง ุฅุตูุงุญ ESLint
        run: |
          echo "๐ง ุฅุตูุงุญ ESLint errors..."
          npm run lint:fix || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน ESLint errors"

      - name: ๐ง ุฅุตูุงุญ TypeScript
        run: |
          echo "๐ง ุฅุตูุงุญ TypeScript errors..."
          npm run type:check || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน TypeScript errors"

      - name: ๐ง ุฅุตูุงุญ ุงูุฃูุงู
        run: |
          echo "๐ง ุฅุตูุงุญ security issues..."
          npm run security:fix || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน security issues"

      - name: ๐ ุฅูุดุงุก commit ููุฅุตูุงุญุงุช
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if git diff --staged --quiet; then
            echo "ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฅุตูุงุญ"
          else
            git commit -m "๐ง AutoFix: AI Agent - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

  # ๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ
  report:
    name: ๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ
    runs-on: ubuntu-latest
    needs: [code-analysis, testing, smart-agent, auto-fix]
    if: always()
    steps:
      - name: ๐ฅ ุชุญููู ุงููุชุงุฆุฌ
        uses: actions/download-artifact@v4
        with:
          name: agent-results-${{ github.run_number }}
          path: ./results

      - name: ๐ ุฅูุดุงุก ุงูุชูุฑูุฑ
        run: |
          echo "๐ ุฅูุดุงุก ุชูุฑูุฑ ุงููุชุงุฆุฌ..."
          echo "## ๐ค Smart Bootloader Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุชุงุฑูุฎ: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุฏูุฑุฉ: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฟ ุงููุฑุน: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### โ ุงููุชุงุฆุฌ:" >> $GITHUB_STEP_SUMMARY
          echo "- ุชุญููู ุงูููุฏ: ${{ needs.code-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูุงุฎุชุจุงุฑุงุช: ${{ needs.testing.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูู Agent: ${{ needs.smart-agent.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูุฅุตูุงุญ ุงูุชููุงุฆู: ${{ needs.auto-fix.result }}" >> $GITHUB_STEP_SUMMARY

      - name: ๐ง ุฅุฑุณุงู ุงูุชูุจููุงุช
        if: failure()
        run: |
          echo "๐ง ุฅุฑุณุงู ุชูุจููุงุช ุงููุดู..."
          # ูููู ุฅุถุงูุฉ ุฅุฑุณุงู ุฅูููู ุฃู Slack notification ููุง

  # ๐ ุงููุดุฑ ุงูุชููุงุฆู
  deploy:
    name: ๐ ุงููุดุฑ ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: [code-analysis, testing, smart-agent]
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐๏ธ ุจูุงุก ุงููุดุฑูุน
        run: npm run build

      - name: ๐ ุงููุดุฑ
        run: |
          echo "๐ ูุดุฑ ุงููุดุฑูุน..."
          npm run deploy:prod

      - name: ๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        run: |
          echo "๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช..."
          # ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ูุงููุฑุงูุจุฉ

  # ๐งน ุชูุธูู
  cleanup:
    name: ๐งน ุชูุธูู
    runs-on: ubuntu-latest
    needs: [report, deploy]
    if: always()
    steps:
      - name: ๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
        run: |
          echo "๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ..."
          # ุญุฐู ุงููููุงุช ุงููุคูุชุฉ

      - name: ๐ ุชุญุฏูุซ ุงูุณุฌูุงุช
        run: |
          echo "๐ ุชุญุฏูุซ ุณุฌูุงุช ุงููุธุงู..."
          # ุชุญุฏูุซ ุณุฌูุงุช ุงููุธุงู
