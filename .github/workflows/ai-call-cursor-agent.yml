name: ๐ค AI via Cursor Background Agent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches:
      - main
      - develop
  schedule:
    - cron: '0 */6 * * *' # ุชุดุบูู ูู 6 ุณุงุนุงุช
  workflow_dispatch:
    inputs:
      mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - fix-only
          - test-only
          - optimize-only
          - refactor
          - background
          - monitor
          - heal

env:
  NODE_VERSION: '18'
  NPM_VERSION: '8'

jobs:
  call_cursor_agent:
    name: ๐ค ุงุณุชุฏุนุงุก Cursor Background Agent
    runs-on: ubuntu-latest
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright install chromium

      - name: ๐ค ุงุณุชุฏุนุงุก Cursor Background Agent API
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "๐ค ุงุณุชุฏุนุงุก Cursor Background Agent..."
          
          # ุฅูุดุงุก payload ููู API
          cat > agent_payload.json << 'EOF'
          {
            "repo": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "name": "ai-self-healing-agent",
            "description": "AI Self-Healing CI/CD Agent for automatic code fixing and testing",
            "instructions": "Run node scripts/ai_self_test_and_fix.mjs --agent-mode=cursor --mode=${{ github.event.inputs.mode || 'auto' }}; commit fixes to ai-auto-fixes branch and open PR if needed. Use Supabase credentials for database operations. Provide comprehensive testing with Playwright and Supawright.",
            "max_runtime_minutes": 120,
            "environment": {
              "NODE_ENV": "production",
              "NEXT_PUBLIC_SUPABASE_URL": "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}",
              "NEXT_PUBLIC_SUPABASE_ANON_KEY": "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}",
              "SUPABASE_SERVICE_ROLE_KEY": "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}",
              "CURSOR_API_KEY": "${{ secrets.CURSOR_API_KEY }}",
              "LLM_PROVIDER": "cursor"
            },
            "safety": {
              "backup_before_modification": true,
              "revert_on_unfixable_error": true,
              "max_files_to_change": 50,
              "max_lines_to_change": 1000,
              "require_approval_for_pr": true,
              "create_backup_branch": "ai-auto-fixes"
            }
          }
          EOF
          
          # ุงุณุชุฏุนุงุก Cursor API
          curl -X POST "https://api.cursor.com/background-agents" \
            -H "Authorization: Bearer $CURSOR_API_KEY" \
            -H "Content-Type: application/json" \
            -d @agent_payload.json \
            --fail-with-body || echo "โ๏ธ ูุดู ูู ุงุณุชุฏุนุงุก Cursor API - ุณูุชู ุชุดุบูู ุงูุณูุฑูุจุช ูุญููุงู"
          
          # ุชุดุบูู ุงูุณูุฑูุจุช ูุญููุงู ูุจุฏูู
          echo "๐ ุชุดุบูู ุงูุณูุฑูุจุช ูุญููุงู ูุจุฏูู..."
          node scripts/ai_self_test_and_fix.mjs --agent-mode=cursor --mode=${{ github.event.inputs.mode || 'auto' }}

      - name: ๐ ุญูุธ ุงููุชุงุฆุฌ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cursor-agent-results-${{ github.run_number }}
          path: |
            reports/
            logs/
          retention-days: 30

      - name: ๐ ุฅูุดุงุก ุงูุชูุฑูุฑ
        run: |
          echo "๐ ุฅูุดุงุก ุชูุฑูุฑ Cursor Agent..."
          echo "## ๐ค Cursor Background Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุชุงุฑูุฎ: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุฏูุฑุฉ: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฟ ุงููุฑุน: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฏ ุงููุถุน: ${{ github.event.inputs.mode || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### โ ุงููุชุงุฆุฌ:" >> $GITHUB_STEP_SUMMARY
          echo "- ุชู ุงุณุชุฏุนุงุก Cursor Background Agent ุจูุฌุงุญ" >> $GITHUB_STEP_SUMMARY
          echo "- ุชู ุชุดุบูู ุงูุณูุฑูุจุช ุงููุญูู ูุจุฏูู" >> $GITHUB_STEP_SUMMARY
          echo "- ุชู ุญูุธ ุงููุชุงุฆุฌ ูู artifacts" >> $GITHUB_STEP_SUMMARY

      - name: ๐ง ุฅุฑุณุงู ุงูุชูุจููุงุช
        if: failure()
        run: |
          echo "๐ง ุฅุฑุณุงู ุชูุจููุงุช ุงููุดู..."
          # ูููู ุฅุถุงูุฉ ุฅุฑุณุงู ุฅูููู ุฃู Slack notification ููุง
