name: ğŸ¤– CI Assistant - Self-Healing Error Resolver

on:
  workflow_run:
    workflows: ["ğŸš€ Ultimate CI Self-Healing Agent"]
    types: [completed]
    branches: [main, develop, feature/*, hotfix/*, ai-auto-fixes/*]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write
  actions: read

env:
  NODE_VERSION: '20'
  NPM_VERSION: '10'
  CI: true
  NODE_ENV: production

jobs:
  analyze-and-fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          npm ci
          npm install js-yaml sqlite3
          npx playwright install --with-deps chromium

      - name: ğŸ§  ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…
        run: |
          echo "ğŸ§  ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…..."
          node scripts/ci-learning-db.js init

      - name: ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
        id: analyze-error
        run: |
          echo "ğŸ” ØªØ­Ù„ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ù€ Self-Healing..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„
          mkdir -p analysis/ learning/ logs/
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ
          echo "ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ..."
          node scripts/ci-self-healing-manager.js analyze .github/workflows/ultimate-ci-self-healing.yml "Workflow execution failed" || echo "ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£"

      - name: ğŸ¤– Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø·Ø£ Ø¥Ù„Ù‰ Cursor Background Agent
        run: |
          echo "ğŸ¤– Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø·Ø£ Ø¥Ù„Ù‰ Cursor Background Agent..."
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ Ù…Ø¹ Cursor Agent
          echo "ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ Ù…Ø¹ Cursor Agent..."
          node scripts/ci-self-healing-manager.js fix .github/workflows/ultimate-ci-self-healing.yml "YAML syntax error" || echo "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ"

      - name: ğŸ§  Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø®Ø·Ø£
        run: |
          echo "ğŸ§  Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø®Ø·Ø£..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ¹Ù„Ù…
          mkdir -p learning/
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…
          echo "ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…..."
          node scripts/ci-learning-db.js init

      - name: ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        run: |
          echo "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          
          # ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ÙØ±ØºØ©
          if [[ "${{ github.event.workflow_run.head_commit.message }}" == *"ğŸ¤– CI Assistant"* ]] || [[ "${{ github.event.workflow_run.head_commit.message }}" == *"CI Assistant"* ]]; then
            echo "âš ï¸ ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ÙØ±ØºØ©"
            exit 0
          fi
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Git
          git config --local user.email "action@github.com"
          git config --local user.name "CI Assistant"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git add .
          
          # Ø¥Ù†Ø´Ø§Ø¡ commit Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø®Ø§ØµØ©
          git commit -m "ğŸ¤– CI Assistant: Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ ÙÙŠ Self-Healing - ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ - ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© - ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®Ø·Ø£ ğŸ¤– ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©: CI Assistant" || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        run: |
          echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          git push origin ${{ github.ref_name }} || echo "ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"

      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­
        run: |
          echo "ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
          cat > reports/ci-assistant-report.md << 'EOF'
          # ğŸ¤– ØªÙ‚Ø±ÙŠØ± CI Assistant
          
          ## ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
          - **Ø§Ù„ÙˆÙ‚Øª:** $(date)
          - **Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£:** Workflow execution failed
          - **Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ø¨Ù‚:** Self-healing manager with learning
          - **Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­:** intelligent-fix
          
          ## ğŸ”§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©
          1. ØªØ­Ù„ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ù€ Self-Healing workflow
          2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠ
          3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          4. Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ¹Ù„Ù…
          5. Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          
          ## ğŸ“š Ø§Ù„ØªØ¹Ù„Ù…
          - ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
          - ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          - Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØªØ¬Ù†Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
          
          ## âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø©
          ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­"

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        uses: actions/upload-artifact@v4
        with:
          name: ci-assistant-report
          path: |
            reports/
            learning/
            analysis/
          retention-days: 30