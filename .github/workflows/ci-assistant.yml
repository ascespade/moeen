name: ğŸ¤– CI Assistant - Self-Healing Error Resolver

on:
  workflow_run:
    workflows: ["ğŸš€ Ultimate CI Self-Healing Agent"]
    types: [completed]
    branches: [main, develop, feature/*, hotfix/*, ai-auto-fixes/*]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write
  actions: read

env:
  NODE_VERSION: '20'
  NPM_VERSION: '10'
  CI: true
  NODE_ENV: production

jobs:
  analyze-and-fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          npm ci
          npm install js-yaml
          npx playwright install --with-deps chromium

      - name: ğŸ” ØªØ­Ù„ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ù€ Self-Healing
        id: analyze-error
        run: |
          echo "ğŸ” ØªØ­Ù„ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ù€ Self-Healing..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„
          mkdir -p analysis/ learning/ logs/
          
          # ØªØ­Ù„ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            class ErrorAnalyzer {
              constructor() {
                this.errors = [];
                this.learningData = this.loadLearningData();
                this.solutions = this.loadSolutions();
              }
              
              loadLearningData() {
                try {
                  return JSON.parse(fs.readFileSync('learning/error-patterns.json', 'utf8'));
                } catch {
                  return {};
                }
              }
              
              loadSolutions() {
                try {
                  return JSON.parse(fs.readFileSync('learning/known-solutions.json', 'utf8'));
                } catch {
                  return {};
                }
              }
              
              analyzeWorkflowError() {
                console.log('ğŸ” ØªØ­Ù„ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ù€ workflow...');
                
            // ØªØ­Ù„ÙŠÙ„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù€ workflow ÙÙ‚Ø·
            const workflowErrors = [
              {
                pattern: 'YAML parsing error',
                solution: 'Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© YAML syntax ÙÙŠ Ø§Ù„Ù€ workflow',
                fix: 'fix-workflow-yaml'
              },
              {
                pattern: 'Invalid workflow',
                solution: 'Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© workflow syntax',
                fix: 'fix-workflow-syntax'
              },
              {
                pattern: 'Permission denied',
                solution: 'Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù€ workflow',
                fix: 'fix-workflow-permissions'
              },
              {
                pattern: 'Artifact not found',
                solution: 'Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù€ artifacts ÙÙŠ Ø§Ù„Ù€ workflow',
                fix: 'fix-workflow-artifacts'
              },
              {
                pattern: 'Timeout',
                solution: 'Ø²ÙŠØ§Ø¯Ø© timeout ÙÙŠ Ø§Ù„Ù€ workflow',
                fix: 'fix-workflow-timeout'
              }
            ];
                
                // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
                const errorType = this.detectErrorType();
                const error = workflowErrors.find(e => errorType.includes(e.pattern)) || {
                  pattern: 'Unknown',
                  solution: 'ØªØ­Ù„ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ø·Ù„ÙˆØ¨',
                  fix: 'manual-analysis'
                };
                
                console.log(\`ğŸ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£: \${error.pattern}\`);
                console.log(\`ğŸ’¡ Ø§Ù„Ø­Ù„: \${error.solution}\`);
                
                this.errors.push({
                  type: error.pattern,
                  solution: error.solution,
                  fix: error.fix,
                  timestamp: new Date().toISOString()
                });
                
                return error;
              }
              
              detectErrorType() {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                try {
                  const logFiles = [
                    'logs/error.log',
                    'logs/workflow-error.log',
                    '.github/workflows/ultimate-ci-self-healing.yml'
                  ];
                  
                  for (const file of logFiles) {
                    if (fs.existsSync(file)) {
                      const content = fs.readFileSync(file, 'utf8');
                      return content;
                    }
                  }
                } catch (e) {
                  console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡');
                }
                
                return 'Unknown error';
              }
              
              saveAnalysis() {
                const analysis = {
                  timestamp: new Date().toISOString(),
                  errors: this.errors,
                  learningData: this.learningData,
                  solutions: this.solutions
                };
                
                fs.writeFileSync('analysis/error-analysis.json', JSON.stringify(analysis, null, 2));
                console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡');
              }
            }
            
            const analyzer = new ErrorAnalyzer();
            const error = analyzer.analyzeWorkflowError();
            analyzer.saveAnalysis();
            
            // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
            console.log(\`error-type=\${error.pattern}\` >> $GITHUB_OUTPUT);
            console.log(\`solution=\${error.solution}\` >> $GITHUB_OUTPUT);
            console.log(\`fix-type=\${error.fix}\` >> $GITHUB_OUTPUT);
          "

      - name: ğŸ”§ Ø¥ØµÙ„Ø§Ø­ workflow ÙÙ‚Ø·
        run: |
          echo "ğŸ”§ Ø¥ØµÙ„Ø§Ø­ workflow ÙÙ‚Ø· - Ù„Ø§ ÙŠØµÙ„Ø­ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±..."
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ØªØ®ØµØµ
          node scripts/ci-assistant-fixer.js
          
          # Ø¥ØµÙ„Ø§Ø­ workflow ÙÙ‚Ø· - Ù„Ø§ ÙŠØµÙ„Ø­ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±
          echo "ğŸ”§ Ø¥ØµÙ„Ø§Ø­ workflow ÙÙ‚Ø·..."
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ØªØ®ØµØµ Ù„Ù„Ù€ workflows
          node scripts/ci-assistant-fixer.js

      - name: ğŸ§  Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø®Ø·Ø£
        run: |
          echo "ğŸ§  Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø®Ø·Ø£..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ¹Ù„Ù…
          mkdir -p learning/
          
          # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ¹Ù„Ù…
          node -e "
            const fs = require('fs');
            
            const errorInfo = {
              timestamp: new Date().toISOString(),
              errorType: '${{ steps.analyze-error.outputs.error-type }}',
              solution: '${{ steps.analyze-error.outputs.solution }}',
              fixType: '${{ steps.analyze-error.outputs.fix-type }}',
              workflowRunId: '${{ github.event.workflow_run.id }}',
              branch: '${{ github.ref_name }}',
              commit: '${{ github.sha }}'
            };
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            let learningData = [];
            try {
              learningData = JSON.parse(fs.readFileSync('learning/error-history.json', 'utf8'));
            } catch {
              learningData = [];
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            learningData.push(errorInfo);
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            fs.writeFileSync('learning/error-history.json', JSON.stringify(learningData, null, 2));
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            const patterns = {};
            learningData.forEach(error => {
              const key = error.errorType;
              patterns[key] = (patterns[key] || 0) + 1;
            });
            
            fs.writeFileSync('learning/error-patterns.json', JSON.stringify(patterns, null, 2));
            
            console.log('ğŸ“š ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ¹Ù„Ù…');
            console.log(\`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: \${learningData.length}\`);
          "

      - name: ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        run: |
          echo "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          
          # ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ÙØ±ØºØ©
          COMMIT_MSG="${{ github.event.workflow_run.head_commit.message }}"
          if [[ "$COMMIT_MSG" == *"ğŸ¤– CI Assistant"* ]] || [[ "$COMMIT_MSG" == *"CI Assistant"* ]] || [[ "$COMMIT_MSG" == *"Self-Healing"* ]]; then
            echo "âš ï¸ ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ÙØ±ØºØ©"
            echo "ğŸ“ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù€ commit: $COMMIT_MSG"
            exit 0
          fi
          
          # ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª ÙØ¹Ù„Ø§Ù‹
          if git diff --quiet && git diff --cached --quiet; then
            echo "â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
            exit 0
          fi
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Git
          git config --local user.email "action@github.com"
          git config --local user.name "CI Assistant"
          
          # Ø¥Ø¶Ø§ÙØ© workflow files ÙÙ‚Ø· - Ù„Ø§ ÙŠØµÙ„Ø­ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±
          git add .github/workflows/
          
          # Ø¥Ù†Ø´Ø§Ø¡ commit Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø®Ø§ØµØ©
          git commit -m "ğŸ¤– CI Assistant: Ø¥ØµÙ„Ø§Ø­ workflow ÙÙ‚Ø·

ğŸ”§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª (workflow files ÙÙ‚Ø·):
- Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£: ${{ steps.analyze-error.outputs.error-type }}
- Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ø¨Ù‚: ${{ steps.analyze-error.outputs.solution }}
- Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${{ steps.analyze-error.outputs.fix-type }}

ğŸ“š Ø§Ù„ØªØ¹Ù„Ù…:
- ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ¹Ù„Ù…
- ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
- ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®Ø·Ø£

ğŸ¤– ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©: CI Assistant
ğŸš« Ø¥ØµÙ„Ø§Ø­ workflow ÙÙ‚Ø· - Ù„Ø§ ÙŠØµÙ„Ø­ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±" || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        run: |
          echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          git push origin ${{ github.ref_name }} || echo "ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"

      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­
        run: |
          echo "ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
          cat > reports/ci-assistant-report.md << 'EOF'
          # ğŸ¤– ØªÙ‚Ø±ÙŠØ± CI Assistant
          
          ## ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
          - **Ø§Ù„ÙˆÙ‚Øª:** $(date)
          - **Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£:** ${{ steps.analyze-error.outputs.error-type }}
          - **Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ø¨Ù‚:** ${{ steps.analyze-error.outputs.solution }}
          - **Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­:** ${{ steps.analyze-error.outputs.fix-type }}
          
          ## ğŸ”§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©
          1. ØªØ­Ù„ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ù€ Self-Healing workflow
          2. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
          3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          4. Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ¹Ù„Ù…
          5. Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          
          ## ğŸ“š Ø§Ù„ØªØ¹Ù„Ù…
          - ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
          - ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          - Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØªØ¬Ù†Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
          
          ## âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø©
          ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­"

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        uses: actions/upload-artifact@v4
        with:
          name: ci-assistant-report
          path: |
            reports/
            learning/
            analysis/
          retention-days: 30
