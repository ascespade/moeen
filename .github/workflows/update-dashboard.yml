name: ðŸ“Š Update Dashboard

on:
  workflow_run:
    workflows: ["ðŸ¤– AI Self-Healing CI/CD v3.0"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update_dashboard:
    name: ðŸ“Š ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          npm install
          npm install sqlite3 sqlite --save-dev

      - name: ðŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¥Ù„Ù‰ JSON
        run: |
          echo "ðŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† SQLite Ø¥Ù„Ù‰ JSON..."
          node scripts/ai-logger.mjs export

      - name: ðŸ“ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¬Ù„Ø¯ gh-pages
        run: |
          echo "ðŸ“ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¬Ù„Ø¯ gh-pages..."
          git config --global user.name "AI Agent"
          git config --global user.email "ai-agent@users.noreply.github.com"
          
          # Ø¥Ù†Ø´Ø§Ø¡ ÙØ±Ø¹ gh-pages Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          git fetch origin gh-pages || git checkout --orphan gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¬Ù„Ø¯
          git rm -rf . || true
          
          # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Dashboard
          cp -r dashboard/* .
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù .nojekyll Ù„ØªØ¹Ø·ÙŠÙ„ Jekyll
          touch .nojekyll
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù README
          cat > README.md << 'EOF'
          # ðŸ¤– AI Self-Healing Dashboard
          
          Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†Ø¸Ø§Ù… AI Self-Healing CI/CD v3.0
          
          ## Ø§Ù„Ù…ÙŠØ²Ø§Øª
          
          - ðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª
          - ðŸ“ˆ Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ©
          - ðŸ” Ø¨Ø­Ø« ÙˆØªØµÙÙŠØ© Ù…ØªÙ‚Ø¯Ù…
          - ðŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
          
          ## Ø§Ù„ÙˆØµÙˆÙ„
          
          ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© Ø¹Ø¨Ø±:
          https://$(echo ${{ github.repository }} | cut -d'/' -f1).github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/
          
          ---
          
          *ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨ÙˆØ§Ø³Ø·Ø© AI Self-Healing CI/CD v3.0*
          EOF

      - name: ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        run: |
          echo "ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          git add -A
          git commit -m "ðŸ“Š Update dashboard at $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin gh-pages --force

      - name: ðŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
        run: |
          echo "ðŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«..."
          echo "## ðŸ“Š Dashboard Update Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ø§Ù„ÙˆÙ‚Øª:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ø§Ù„Ø±Ø§Ø¨Ø·:** https://$(echo ${{ github.repository }} | cut -d'/' -f1).github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:" >> $GITHUB_STEP_SUMMARY
          
          # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† logs.json Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if [ -f "logs.json" ]; then
            echo "- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: $(cat logs.json | jq '.stats.total // 0')" >> $GITHUB_STEP_SUMMARY
            echo "- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©: $(cat logs.json | jq '.stats.successful // 0')" >> $GITHUB_STEP_SUMMARY
            echo "- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©: $(cat logs.json | jq '.stats.failed // 0')" >> $GITHUB_STEP_SUMMARY
            echo "- Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©: $(cat logs.json | jq '.stats.avgQuality // 0')%" >> $GITHUB_STEP_SUMMARY
          fi

  deploy_pages:
    name: ðŸš€ Ù†Ø´Ø± GitHub Pages
    runs-on: ubuntu-latest
    needs: update_dashboard
    
    steps:
      - name: ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: ðŸš€ Ù†Ø´Ø± Ø¥Ù„Ù‰ GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: false

      - name: ðŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø±
        run: |
          echo "## ðŸš€ GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Ø§Ù„Ø±Ø§Ø¨Ø·:** https://$(echo ${{ github.repository }} | cut -d'/' -f1).github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/" >> $GITHUB_STEP_SUMMARY
