name: ðŸ¤– Cursor Auto-Fix

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'ÙˆØ´ ØªØ¨ØºÙ‰ Ø§Ù„Ù€ Agent ÙŠØ³ÙˆÙŠØŸ'
        required: false
        default: 'Fix all failing Playwright tests'
      model:
        description: 'Ø£ÙŠ Model ØªØ³ØªØ®Ø¯Ù…ØŸ'
        required: false
        type: choice
        default: 'claude-sonnet-4'
        options:
          - 'claude-sonnet-4'
          - 'gpt-4o'
          - 'gpt-4-turbo'

env:
  NODE_VERSION: '18'
  SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ vars.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  auto-fix:
    name: ðŸ¤– Auto-Fix
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª..."
          npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: |
          echo "ðŸŽ­ ØªØ«Ø¨ÙŠØª Playwright browsers..."
          npx playwright install --with-deps

      - name: ðŸ§ª Run Tests (Before Fix)
        id: test_before
        continue-on-error: true
        run: |
          echo "ðŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­..."
          npm test 2>&1 | tee test-before.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Test Results (Before)
        run: |
          echo "## ðŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test_before.outcome }}" == "success" ]; then
            echo "âœ… **ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§Ø¬Ø­Ø©!** Ù…Ø§ÙÙŠÙ‡ Ø´ÙŠØ¡ ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­ ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ÙÙŠÙ‡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ§Ø´Ù„Ø©** - Ø¨Ù†Ø´ØºÙ„ Ø§Ù„Ù€ Agent Ù„Ù„Ø¥ØµÙ„Ø§Ø­..." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 test-before.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš€ Install Cursor CLI
        if: steps.test_before.outcome == 'failure'
        run: |
          echo "ðŸš€ ØªØ«Ø¨ÙŠØª Cursor CLI..."
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: ðŸ¤– Run Cursor Agent
        if: steps.test_before.outcome == 'failure'
        env:
          CURSOR_API_KEY: ${{ vars.CURSOR_API_KEY }}
        run: |
          echo "ðŸ¤– ØªØ´ØºÙŠÙ„ Cursor Agent..."
          
          PROMPT="${{ github.event.inputs.prompt }}"
          
          cursor-agent -p "
          ðŸ”§ **Ù…Ù‡Ù…Ø© Ø¥ØµÙ„Ø§Ø­ Playwright Tests**
          
          **Ø§Ù„Ø·Ù„Ø¨:** ${PROMPT}
          
          **Ø§Ù„ØªÙØ§ØµÙŠÙ„:**
          - Ø±Ø§Ø¬Ø¹ Ù…Ù„Ù test-before.log Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
          - Ø£ØµÙ„Ø­ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ src/ Ø£Ùˆ tests/ Ø£Ùˆ e2e/
          - ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙŠØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
          
          **Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø©:**
          âŒ Ù„Ø§ ØªØ¹Ø·Ù„ Ø£Ùˆ ØªØ­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          âŒ Ù„Ø§ ØªØ¶Ù setTimeout Ø¹Ø´ÙˆØ§Ø¦ÙŠ
          âŒ Ù„Ø§ ØªØ¹Ù…Ù„ git commit Ø£Ùˆ push
          âŒ Ù„Ø§ ØªØ¹Ø¯Ù„ package.json Ø£Ùˆ workflows
          
          âœ… Ø¹Ø¯Ù„ ÙÙ‚Ø·: src/, tests/, e2e/, components/, lib/
          âœ… Ø£ØµÙ„Ø­ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ
          âœ… Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ù†Ø¸ÙŠÙ ÙˆÙ…ÙÙ‡ÙˆÙ…
          
          **Supabase Config:**
          - URL: ${SUPABASE_URL}
          - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© ÙƒÙ€ environment variables
          " --model ${{ github.event.inputs.model }}

      - name: ðŸ§ª Run Tests (After Fix)
        if: steps.test_before.outcome == 'failure'
        id: test_after
        run: |
          echo "ðŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­..."
          npm ci
          npx playwright install --with-deps
          npm test

      - name: ðŸ“Š Test Results (After)
        if: steps.test_before.outcome == 'failure'
        run: |
          echo "## ðŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test_after.outcome }}" == "success" ]; then
            echo "âœ… **ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­!** ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Ù„Ø§Ø²Ø§Ù„ ÙÙŠÙ‡ Ù…Ø´Ø§ÙƒÙ„** - Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„ ÙŠØ¯ÙˆÙŠ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            test-before.log
            test-results/
            playwright-report/

      - name: âœ… Create Pull Request
        if: steps.test_after.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Ø¥Ù†Ø´Ø§Ø¡ Pull Request..."
          
          BRANCH_NAME="cursor-auto-fix-${{ github.run_id }}"
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ø¥Ù†Ø´Ø§Ø¡ branch Ø¬Ø¯ÙŠØ¯
          git checkout -b ${BRANCH_NAME}
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git add -A
          
          # Commit
          git commit -m "ðŸ¤– fix: auto-fix by Cursor Agent (run #${{ github.run_id }})" || echo "No changes to commit"
          
          # Push
          git push origin ${BRANCH_NAME}
          
          # Ø¥Ù†Ø´Ø§Ø¡ PR
          gh pr create \
            --title "ðŸ¤– Auto-Fix: Tests Fixed by Cursor Agent" \
            --body "## ðŸ¤– Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Cursor Agent
          **ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©:** @${{ github.actor }}
          **Model:** ${{ github.event.inputs.model }}
          **Run ID:** ${{ github.run_id }}
          
          ### âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø©
          ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!
          
          ### ðŸ“Š Ø§Ù„ØªÙØ§ØµÙŠÙ„
          - ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ workflow: [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - Ø§Ù„Ù€ test logs Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ artifacts
          
          ### ðŸ“‹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
          - [ ] Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          - [ ] ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ÙŠ
          - [ ] Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø±ØºÙˆØ¨Ø©
          - [ ] Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ…Ø± Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±
          
          ---
          ðŸ¤– ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ | [Cursor Dashboard](https://cursor.com/dashboard?tab=background-agents)" \
            --base ${{ github.ref_name }} \
            --head ${BRANCH_NAME}

      - name: ðŸ“Š Final Summary
        if: always()
        run: |
          echo "# ðŸŽ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ø´ØºÙ„Ù‡:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** ${{ github.event.inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø¨Ù„: ${{ steps.test_before.outcome }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test_before.outcome }}" == "failure" ]; then
            echo "- ðŸ¤– Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯: ${{ steps.test_after.outcome }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©" >> $GITHUB_STEP_SUMMARY
          echo "- [Cursor Dashboard](https://cursor.com/dashboard?tab=background-agents)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
