name: ๐ค CI Assistant Workflow - Error Resolver

on:
  workflow_run:
    workflows: ['๐ Master CI Workflow - Smart Testing & Auto-Healing']
    types: [completed]
    branches: [main, develop, feature/*, hotfix/*]
  push:
    branches: [main, develop, feature/*, hotfix/*]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write
  actions: read

env:
  NODE_VERSION: '20'
  NPM_VERSION: '10'
  CI: true
  NODE_ENV: production
  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}

jobs:
  # ๐ Job 1: Analyze Master Workflow Failure
  analyze-master-failure:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      failure-reason: ${{ steps.analyze-failure.outputs.failure-reason }}
      error-logs: ${{ steps.analyze-failure.outputs.error-logs }}
      fix-required: ${{ steps.analyze-failure.outputs.fix-required }}

    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ ุงูุจูุฆุฉ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci --ignore-scripts
          npm install js-yaml sqlite3

      - name: ๐ง ุชููุฆุฉ ูุธุงู ุงูุชุนูู
        run: |
          echo "๐ง ุชููุฆุฉ ูุธุงู ุงูุชุนูู..."
          node scripts/ci-learning-db.js init

      - name: ๐ ุชุญููู ูุดู Master Workflow
        id: analyze-failure
        run: |
          echo "๐ ุชุญููู ูุดู Master Workflow..."

          # ุฅูุดุงุก ูุฌูุฏุงุช ุงูุชุญููู
          mkdir -p analysis/ logs/ learning/

          # ุชุญููู ุณุจุจ ุงููุดู
          echo "๐ ุชุญููู ุณุจุจ ุงููุดู..."
          node -e "
            const fs = require('fs');
            
            // ุชุญููู ูุนูููุงุช ุงูู workflow_run
            const workflowRun = process.env.GITHUB_EVENT_PATH ? 
              JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')).workflow_run : 
              null;
            
            let failureReason = 'Unknown failure';
            let errorLogs = '';
            let fixRequired = true;
            
            if (workflowRun) {
              failureReason = workflowRun.conclusion || 'Unknown';
              errorLogs = 'Workflow run ID: ' + workflowRun.id + '\\n';
              errorLogs += 'Status: ' + workflowRun.status + '\\n';
              errorLogs += 'Conclusion: ' + workflowRun.conclusion + '\\n';
              errorLogs += 'URL: ' + workflowRun.html_url + '\\n';
              
              // ุชุญููู ุงูุฃุฎุทุงุก ูู ุงูู jobs
              if (workflowRun.jobs) {
                workflowRun.jobs.forEach(job => {
                  if (job.conclusion === 'failure') {
                    errorLogs += '\\nFailed Job: ' + job.name + '\\n';
                    errorLogs += 'Job ID: ' + job.id + '\\n';
                    errorLogs += 'Steps: ' + JSON.stringify(job.steps, null, 2) + '\\n';
                  }
                });
              }
            }
            
            // ุญูุธ ุชุญููู ุงููุดู
            const analysis = {
              failureReason,
              errorLogs,
              fixRequired,
              timestamp: new Date().toISOString(),
              workflowRunId: workflowRun ? workflowRun.id : null,
              repository: process.env.GITHUB_REPOSITORY,
              branch: process.env.GITHUB_REF_NAME
            };
            
            fs.writeFileSync('analysis/failure-analysis.json', JSON.stringify(analysis, null, 2));
            
            console.log('failure-reason=' + failureReason);
            console.log('error-logs=' + errorLogs.replace(/\\n/g, ' '));
            console.log('fix-required=' + fixRequired);
          "

      - name: ๐ ุญูุธ ุชุญููู ุงููุดู
        uses: actions/upload-artifact@v4
        with:
          name: failure-analysis
          path: analysis/
          retention-days: 7

  # ๐ค Job 2: Send Error to Cursor API for Fix
  send-to-cursor-api:
    if: needs.analyze-master-failure.outputs.fix-required == 'true'
    needs: analyze-master-failure
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      cursor-response: ${{ steps.cursor-api.outputs.cursor-response }}
      fixes-received: ${{ steps.cursor-api.outputs.fixes-received }}
      fix-count: ${{ steps.cursor-api.outputs.fix-count }}

    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ ุงูุจูุฆุฉ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci --ignore-scripts
          npm install js-yaml sqlite3

      - name: ๐ฅ ุชุญููู ุชุญููู ุงููุดู
        uses: actions/download-artifact@v4
        with:
          name: failure-analysis
          path: analysis/

      - name: ๐ค ุฅุฑุณุงู ุงูุฎุทุฃ ูู Cursor API
        id: cursor-api
        run: |
          echo "๐ค ุฅุฑุณุงู ุงูุฎุทุฃ ูู Cursor API ููุฅุตูุงุญ..."

          # ูุฑุงุกุฉ ุชุญููู ุงููุดู
          const analysis = JSON.parse(require('fs').readFileSync('analysis/failure-analysis.json', 'utf8'));

          # ุฅุฑุณุงู ูู Cursor API
          node -e "
            const https = require('https');
            const fs = require('fs');
            
            const analysis = JSON.parse(fs.readFileSync('analysis/failure-analysis.json', 'utf8'));
            
            const payload = {
              errorType: 'workflow_failure',
              failureReason: analysis.failureReason,
              errorLogs: analysis.errorLogs,
              context: {
                repository: process.env.GITHUB_REPOSITORY,
                branch: process.env.GITHUB_REF_NAME,
                commit: process.env.GITHUB_SHA,
                workflowRunId: analysis.workflowRunId,
                timestamp: analysis.timestamp
              },
              files: [
                '.github/workflows/',
                'scripts/',
                'package.json',
                'src/',
                'tests/'
              ],
              priority: 'high',
              requestType: 'workflow_fix'
            };
            
            const options = {
              hostname: 'api.cursor.sh',
              port: 443,
              path: '/v1/fix-workflow-error',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + process.env.CURSOR_API_KEY,
                'X-Request-ID': 'assistant-' + Date.now()
              }
            };
            
            const req = https.request(options, (res) => {
              let data = '';
              res.on('data', (chunk) => data += chunk);
              res.on('end', () => {
                try {
                  const response = JSON.parse(data);
                  console.log('cursor-response=' + (response.success ? 'success' : 'failed'));
                  console.log('fixes-received=' + (response.fixes ? response.fixes.length : 0));
                  console.log('fix-count=' + (response.fixes ? response.fixes.length : 0));
                  
                  // ุญูุธ ุงุณุชุฌุงุจุฉ Cursor
                  fs.writeFileSync('analysis/cursor-response.json', JSON.stringify(response, null, 2));
                } catch (e) {
                  console.log('cursor-response=failed');
                  console.log('fixes-received=0');
                  console.log('fix-count=0');
                  
                  // ุญูุธ ุฎุทุฃ ุงูุงุชุตุงู
                  fs.writeFileSync('analysis/cursor-error.json', JSON.stringify({
                    error: e.message,
                    timestamp: new Date().toISOString()
                  }, null, 2));
                }
              });
            });
            
            req.on('error', (e) => {
              console.log('cursor-response=failed');
              console.log('fixes-received=0');
              console.log('fix-count=0');
              
              // ุญูุธ ุฎุทุฃ ุงูุงุชุตุงู
              fs.writeFileSync('analysis/cursor-error.json', JSON.stringify({
                error: e.message,
                timestamp: new Date().toISOString()
              }, null, 2));
            });
            
            req.write(JSON.stringify(payload));
            req.end();
          "

      - name: ๐ ุญูุธ ุงุณุชุฌุงุจุฉ Cursor
        uses: actions/upload-artifact@v4
        with:
          name: cursor-response
          path: analysis/
          retention-days: 7

  # ๐ง Job 3: Apply Fixes from Cursor API
  apply-cursor-fixes:
    if: needs.send-to-cursor-api.outputs.fixes-received != '0'
    needs: [analyze-master-failure, send-to-cursor-api]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      fixes-applied: ${{ steps.apply-fixes.outputs.fixes-applied }}
      success-count: ${{ steps.apply-fixes.outputs.success-count }}
      failure-count: ${{ steps.apply-fixes.outputs.failure-count }}

    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ ุงูุจูุฆุฉ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci --ignore-scripts
          npm install js-yaml sqlite3

      - name: ๐ฅ ุชุญููู ุงุณุชุฌุงุจุฉ Cursor
        uses: actions/download-artifact@v4
        with:
          name: cursor-response
          path: analysis/

      - name: ๐ง ุชุทุจูู ุงูุฅุตูุงุญุงุช ูู Cursor API
        id: apply-fixes
        run: |
          echo "๐ง ุชุทุจูู ุงูุฅุตูุงุญุงุช ูู Cursor API..."

          if [ -f "analysis/cursor-response.json" ]; then
            node -e "
              const fs = require('fs');
              const response = JSON.parse(fs.readFileSync('analysis/cursor-response.json', 'utf8'));
              
              let fixesApplied = 0;
              let successCount = 0;
              let failureCount = 0;
              
              if (response.fixes && response.fixes.length > 0) {
                console.log('๐ง ุชุทุจูู ' + response.fixes.length + ' ุฅุตูุงุญ ูู Cursor API...');
                
                response.fixes.forEach((fix, index) => {
                  try {
                    if (fix.file && fix.content) {
                      // ุฅูุดุงุก ูุฌูุฏ ุงูููู ุฅุฐุง ูู ููู ููุฌูุฏุงู
                      const dir = fix.file.substring(0, fix.file.lastIndexOf('/'));
                      if (dir) {
                        fs.mkdirSync(dir, { recursive: true });
                      }
                      
                      // ูุชุงุจุฉ ุงููุญุชูู
                      fs.writeFileSync(fix.file, fix.content);
                      console.log('โ ุชู ุฅุตูุงุญ: ' + fix.file);
                      fixesApplied++;
                      successCount++;
                    } else {
                      console.log('โ๏ธ ุฅุตูุงุญ ุบูุฑ ุตุงูุญ: ' + JSON.stringify(fix));
                      failureCount++;
                    }
                  } catch (e) {
                    console.log('โ ูุดู ูู ุฅุตูุงุญ: ' + fix.file + ' - ' + e.message);
                    failureCount++;
                  }
                });
              } else {
                console.log('โ๏ธ ูุง ุชูุฌุฏ ุฅุตูุงุญุงุช ูู ุงุณุชุฌุงุจุฉ Cursor API');
              }
              
              console.log('fixes-applied=' + fixesApplied);
              console.log('success-count=' + successCount);
              console.log('failure-count=' + failureCount);
              
              // ุญูุธ ุชูุฑูุฑ ุงูุฅุตูุงุญ
              fs.writeFileSync('analysis/fix-report.json', JSON.stringify({
                fixesApplied,
                successCount,
                failureCount,
                timestamp: new Date().toISOString()
              }, null, 2));
            "
          else
            echo "โ ูุง ููุฌุฏ ููู ุงุณุชุฌุงุจุฉ ูู Cursor API"
            echo "fixes-applied=0"
            echo "success-count=0"
            echo "failure-count=0"
          fi

      - name: ๐ ูุญุต ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ
        run: |
          echo "๐ ูุญุต ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ..."

          # ูุญุต ุงูู workflows
          node scripts/validate-workflows.js > logs/post-fix-validation.log 2>&1

          # ูุญุต ุงูููุฏ
          npm run lint > logs/post-fix-lint.log 2>&1 || echo "Lint check completed"

          # ุชุญููู ุงููุชุงุฆุฌ
          node -e "
            const fs = require('fs');
            
            let validationErrors = 0;
            let lintErrors = 0;
            
            if (fs.existsSync('logs/post-fix-validation.log')) {
              const content = fs.readFileSync('logs/post-fix-validation.log', 'utf8');
              const errorMatches = content.match(/โ/g);
              validationErrors = errorMatches ? errorMatches.length : 0;
            }
            
            if (fs.existsSync('logs/post-fix-lint.log')) {
              const content = fs.readFileSync('logs/post-fix-lint.log', 'utf8');
              const errorMatches = content.match(/error/g);
              lintErrors = errorMatches ? errorMatches.length : 0;
            }
            
            console.log('Validation errors: ' + validationErrors);
            console.log('Lint errors: ' + lintErrors);
            
            // ุญูุธ ุชูุฑูุฑ ุงููุญุต
            fs.writeFileSync('analysis/validation-report.json', JSON.stringify({
              validationErrors,
              lintErrors,
              timestamp: new Date().toISOString()
            }, null, 2));
          "

      - name: ๐ ุญูุธ ุชูุฑูุฑ ุงูุฅุตูุงุญ
        uses: actions/upload-artifact@v4
        with:
          name: fix-application-report
          path: |
            analysis/
            logs/
          retention-days: 7

  # ๐พ Job 4: Commit and Push Fixes
  commit-and-push:
    if: needs.apply-cursor-fixes.outputs.fixes-applied != '0'
    needs: [analyze-master-failure, send-to-cursor-api, apply-cursor-fixes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      commit-hash: ${{ steps.commit.outputs.commit-hash }}
      push-success: ${{ steps.push.outputs.push-success }}

    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ๐ฅ ุชุญููู ุชูุฑูุฑ ุงูุฅุตูุงุญ
        uses: actions/download-artifact@v4
        with:
          name: fix-application-report
          path: analysis/

      - name: ๐พ ุฅูุดุงุก Commit ููุฅุตูุงุญุงุช
        id: commit
        run: |
          echo "๐พ ุฅูุดุงุก Commit ููุฅุตูุงุญุงุช..."

          # ุฅุนุฏุงุฏ Git
          git config --local user.email "ci-assistant@github.com"
          git config --local user.name "CI Assistant"

          # ุฅุถุงูุฉ ุฌููุน ุงูุชุบููุฑุงุช
          git add .

          # ุฅูุดุงุก commit
          git commit -m "๐ค CI Assistant: ุฅุตูุงุญ ูุดู Master Workflow" || echo "ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุญูุธ"

          # ุงูุญุตูู ุนูู hash ุงูู commit
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit-hash=$COMMIT_HASH"

      - name: ๐ค ุฑูุน ุงูุฅุตูุงุญุงุช
        id: push
        run: |
          echo "๐ค ุฑูุน ุงูุฅุตูุงุญุงุช..."

          # ุฑูุน ุงูุชุบููุฑุงุช
          if git push origin ${{ github.ref_name }}; then
            echo "push-success=true"
            echo "โ ุชู ุฑูุน ุงูุฅุตูุงุญุงุช ุจูุฌุงุญ"
          else
            echo "push-success=false"
            echo "โ ูุดู ูู ุฑูุน ุงูุฅุตูุงุญุงุช"
            exit 1
          fi

  # ๐ Job 5: Generate Assistant Report
  generate-assistant-report:
    if: always()
    needs:
      [
        analyze-master-failure,
        send-to-cursor-api,
        apply-cursor-fixes,
        commit-and-push,
      ]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ๐ฅ ุชุญููู ุฌููุน ุงูุชูุงุฑูุฑ
        uses: actions/download-artifact@v4
        with:
          name: fix-application-report
          path: analysis/

      - name: ๐ ุฅูุดุงุก ุชูุฑูุฑ CI Assistant
        run: |
          echo "๐ ุฅูุดุงุก ุชูุฑูุฑ CI Assistant..."

          # ุฅูุดุงุก ุงูุชูุฑูุฑ
          cat > CI_ASSISTANT_REPORT.md << 'EOF'
          # ๐ค CI Assistant Workflow - ุงูุชูุฑูุฑ ุงูููุงุฆู

          ## ๐ ููุฎุต ุงูุชูููุฐ
          - **ุงูุชุงุฑูุฎ:** $(date)
          - **ุงููุฑุน:** ${{ github.ref_name }}
          - **ุงูููููุช:** ${{ github.sha }}
          - **ุงููุดุบู:** ${{ github.actor }}

          ## ๐ ุชุญููู ูุดู Master Workflow
          - **ุณุจุจ ุงููุดู:** ${{ needs.analyze-master-failure.outputs.failure-reason }}
          - **ุญุงูุฉ ุงูุฅุตูุงุญ:** ${{ needs.analyze-master-failure.outputs.fix-required }}

          ## ๐ค ุชูุงุนู Cursor API
          - **ุงุณุชุฌุงุจุฉ Cursor:** ${{ needs.send-to-cursor-api.outputs.cursor-response }}
          - **ุงูุฅุตูุงุญุงุช ุงููุณุชููุฉ:** ${{ needs.send-to-cursor-api.outputs.fixes-received }}

          ## ๐ง ุชุทุจูู ุงูุฅุตูุงุญุงุช
          - **ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:** ${{ needs.apply-cursor-fixes.outputs.fixes-applied }}
          - **ูุฌุญ:** ${{ needs.apply-cursor-fixes.outputs.success-count }}
          - **ูุดู:** ${{ needs.apply-cursor-fixes.outputs.failure-count }}

          ## ๐พ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ
          - **Commit Hash:** ${{ needs.commit-and-push.outputs.commit-hash }}
          - **ุฑูุน ูุงุฌุญ:** ${{ needs.commit-and-push.outputs.push-success }}

          ## โ ุงูุญุงูุฉ ุงูููุงุฆูุฉ
          EOF

          # ุฅุถุงูุฉ ุงูุชูุงุตูู
          if [ -f "analysis/fix-report.json" ]; then
            node -e "
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('analysis/fix-report.json', 'utf8'));
              
              const details = \`
          ### ๐ ุชูุงุตูู ุงูุฅุตูุงุญ
          - **ุฅุฌูุงูู ุงูุฅุตูุงุญุงุช:** \${report.fixesApplied}
          - **ูุฌุญ:** \${report.successCount}
          - **ูุดู:** \${report.failureCount}
          - **ูุนุฏู ุงููุฌุงุญ:** \${report.fixesApplied > 0 ? (report.successCount / report.fixesApplied * 100).toFixed(2) : 0}%

          ### ๐ฏ ุงูุชูุตูุงุช
          \${report.failureCount > 0 ? 'โ๏ธ ุจุนุถ ุงูุฅุตูุงุญุงุช ูุดูุช - ูุญุชุงุฌ ูุฑุงุฌุนุฉ' : 'โ ุฌููุน ุงูุฅุตูุงุญุงุช ูุฌุญุช'}
          \${report.successCount > 0 ? 'โ ุชู ุฅุตูุงุญ ุงููุดููุฉ - Master Workflow ุณูุนูู ูุฑุฉ ุฃุฎุฑู' : 'โ ูู ูุชู ุฅุตูุงุญ ุงููุดููุฉ'}

          ### ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ
          1. Master Workflow ุณูุนูู ุชููุงุฆูุงู ูุฑุฉ ุฃุฎุฑู
          2. ูุฑุงูุจุฉ ุงููุชุงุฆุฌ
          3. ุชุญุณูู ูุธุงู ุงูุฅุตูุงุญ ุฅุฐุง ูุฒู ุงูุฃูุฑ
          \`;
              
              fs.appendFileSync('CI_ASSISTANT_REPORT.md', details);
            "
          fi

      - name: ๐พ ุญูุธ ุงูุชูุฑูุฑ
        run: |
          echo "๐พ ุญูุธ ุงูุชูุฑูุฑ..."

          # ุฅุนุฏุงุฏ Git
          git config --local user.email "ci-assistant@github.com"
          git config --local user.name "CI Assistant"

          # ุฅุถุงูุฉ ุงูุชูุฑูุฑ
          git add CI_ASSISTANT_REPORT.md

          # ุฅูุดุงุก commit ููุชูุฑูุฑ
          git commit -m "๐ CI Assistant Report - $(date '+%Y-%m-%d %H:%M:%S')" || echo "ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุญูุธ"

      - name: ๐ค ุฑูุน ุงูุชูุฑูุฑ
        run: |
          echo "๐ค ุฑูุน ุงูุชูุฑูุฑ..."
          git push origin ${{ github.ref_name }} || echo "ูุดู ูู ุฑูุน ุงูุชูุฑูุฑ"

      - name: ๐ ุฑูุน ุงูุชูุฑูุฑ ูู Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-assistant-final-report
          path: CI_ASSISTANT_REPORT.md
          retention-days: 30
