name: ๐ค AI Self-Healing CI/CD v3.0

on:
  push:
    branches: [ main, develop, auto/* ]
  pull_request:
    branches: [ main ]
  schedule:
    # ุชุดุบูู ูู 4 ุณุงุนุงุช
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - fix-only
          - test-only
          - optimize-only
          - refactor
          - background-agent

env:
  NODE_VERSION: '18'
  NPM_VERSION: '8'
  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  # ๐ ูุญุต ุณุฑูุน
  quick-check:
    name: ๐ ูุญุต ุณุฑูุน
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช ุงูุฃุณุงุณูุฉ
        run: |
          npm ci --only=production
          npm install -g @typescript-eslint/parser @typescript-eslint/eslint-plugin

      - name: ๐ ูุญุต ุณุฑูุน ููููุฏ
        run: |
          echo "๐ ูุญุต ุณุฑูุน..."
          npm run lint:check || echo "โ๏ธ ESLint issues found"
          npm run type:check || echo "โ๏ธ TypeScript issues found"

  # ๐งช ุงูุงุฎุชุจุงุฑุงุช ุงูุณุฑูุนุฉ
  quick-tests:
    name: ๐งช ุงุฎุชุจุงุฑุงุช ุณุฑูุนุฉ
    runs-on: ubuntu-latest
    needs: quick-check
    timeout-minutes: 10
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ..."
          npm run test:unit || echo "โ๏ธ Unit tests failed"

      - name: ๐ ูุญุต ุงูุชุบุทูุฉ
        run: |
          echo "๐ ูุญุต ุชุบุทูุฉ ุงูุงุฎุชุจุงุฑุงุช..."
          npm run test:coverage || echo "โ๏ธ Coverage check failed"

  # ๐ค ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช
  background-agent:
    name: ๐ค ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช
    runs-on: ubuntu-latest
    needs: [quick-check, quick-tests]
    if: always()
    timeout-minutes: 30
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐ง ุฅุนุฏุงุฏ Git
        run: |
          git config --local user.email "ai-agent@github.com"
          git config --local user.name "AI Background Agent"
          git config --local pull.rebase false

      - name: ๐ค ุชุดุบูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช
        run: |
          echo "๐ค ุชุดุบูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช..."
          case "${{ github.event.inputs.mode || 'auto' }}" in
            "auto")
              npm run agent:auto
              ;;
            "fix-only")
              npm run agent:fix
              ;;
            "test-only")
              npm run agent:test
              ;;
            "optimize-only")
              npm run agent:optimize
              ;;
            "refactor")
              npm run agent:refactor
              ;;
            "background-agent")
              npm run agent:auto
              ;;
            *)
              npm run agent:auto
              ;;
          esac

      - name: ๐ ุชุญููู ุงููุชุงุฆุฌ
        run: |
          echo "๐ ุชุญููู ูุชุงุฆุฌ ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช..."
          if [ -f "reports/final_summary.md" ]; then
            echo "๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ:"
            cat reports/final_summary.md
          fi

      - name: ๐พ ุญูุธ ุงูุชูุงุฑูุฑ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: background-agent-results-${{ github.run_number }}
          path: |
            reports/
            logs/
            *.log
          retention-days: 30

  # ๐ง ุงูุฅุตูุงุญ ุงูุชููุงุฆู
  auto-fix:
    name: ๐ง ุงูุฅุตูุงุญ ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: background-agent
    if: failure() && github.event_name == 'push'
    timeout-minutes: 15
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐ง ุฅุตูุงุญ ESLint
        run: |
          echo "๐ง ุฅุตูุงุญ ESLint errors..."
          npm run lint:fix || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน ESLint errors"

      - name: ๐ง ุฅุตูุงุญ TypeScript
        run: |
          echo "๐ง ุฅุตูุงุญ TypeScript errors..."
          npm run type:check || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน TypeScript errors"

      - name: ๐ง ุฅุตูุงุญ ุงูุงุฎุชุจุงุฑุงุช
        run: |
          echo "๐ง ุฅุตูุงุญ ุงูุงุฎุชุจุงุฑุงุช..."
          npm run test:unit || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช"

      - name: ๐ ุฅูุดุงุก commit ููุฅุตูุงุญุงุช
        run: |
          git config --local user.email "ai-agent@github.com"
          git config --local user.name "AI Background Agent"
          git add .
          if git diff --staged --quiet; then
            echo "ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฅุตูุงุญ"
          else
            git commit -m "๐ง AutoFix: AI Background Agent - $(date '+%Y-%m-%d %H:%M:%S')

            ๐ค ุฅุตูุงุญุงุช ุชููุงุฆูุฉ ูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช:
            - ุฅุตูุงุญ ESLint errors
            - ุฅุตูุงุญ TypeScript errors  
            - ุฅุตูุงุญ ุงูุงุฎุชุจุงุฑุงุช
            - ุชุญุณูู ุฌูุฏุฉ ุงูููุฏ
            
            ๐ ุชู ุจูุงุณุทุฉ: AI Background Agent v3.0"
            git push
          fi

  # ๐งช ุงูุงุฎุชุจุงุฑุงุช ุงูุดุงููุฉ
  comprehensive-tests:
    name: ๐งช ุงุฎุชุจุงุฑุงุช ุดุงููุฉ
    runs-on: ubuntu-latest
    needs: [background-agent, auto-fix]
    if: always()
    timeout-minutes: 20
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช E2E
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช E2E..."
          npm run test:e2e || echo "โ๏ธ E2E tests failed"

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู..."
          npm run test:integration || echo "โ๏ธ Integration tests failed"

      - name: ๐ ูุญุต ุงูุฃุฏุงุก
        run: |
          echo "๐ ูุญุต ุงูุฃุฏุงุก..."
          npm run test:coverage || echo "โ๏ธ Coverage check failed"

  # ๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ
  report:
    name: ๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ
    runs-on: ubuntu-latest
    needs: [quick-check, quick-tests, background-agent, auto-fix, comprehensive-tests]
    if: always()
    steps:
      - name: ๐ฅ ุชุญููู ุงููุชุงุฆุฌ
        uses: actions/download-artifact@v4
        with:
          name: background-agent-results-${{ github.run_number }}
          path: ./results

      - name: ๐ ุฅูุดุงุก ุงูุชูุฑูุฑ
        run: |
          echo "๐ ุฅูุดุงุก ุชูุฑูุฑ ุงููุชุงุฆุฌ..."
          echo "## ๐ค AI Self-Healing CI/CD v3.0 Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุชุงุฑูุฎ: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุฏูุฑุฉ: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฟ ุงููุฑุน: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฏ ุงููุถุน: ${{ github.event.inputs.mode || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### โ ุงููุชุงุฆุฌ:" >> $GITHUB_STEP_SUMMARY
          echo "- ูุญุต ุณุฑูุน: ${{ needs.quick-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงุฎุชุจุงุฑุงุช ุณุฑูุนุฉ: ${{ needs.quick-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช: ${{ needs.background-agent.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูุฅุตูุงุญ ุงูุชููุงุฆู: ${{ needs.auto-fix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงุฎุชุจุงุฑุงุช ุดุงููุฉ: ${{ needs.comprehensive-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฏ ุงูุชูุตูุงุช:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.background-agent.result }}" == "success" ]; then
            echo "โ ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช ูุนูู ุจุดูู ูุซุงูู" >> $GITHUB_STEP_SUMMARY
          else
            echo "โ๏ธ ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช ูุญุชุงุฌ ูุฑุงุฌุนุฉ" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.auto-fix.result }}" == "success" ]; then
            echo "โ ุงูุฅุตูุงุญ ุงูุชููุงุฆู ูุฌุญ" >> $GITHUB_STEP_SUMMARY
          else
            echo "โน๏ธ ูุง ุชูุฌุฏ ูุดุงูู ุชุญุชุงุฌ ุฅุตูุงุญ ุชููุงุฆู" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ๐ง ุฅุฑุณุงู ุงูุชูุจููุงุช
        if: failure()
        run: |
          echo "๐ง ุฅุฑุณุงู ุชูุจููุงุช ุงููุดู..."
          echo "โ ูุดู ูู AI Self-Healing CI/CD v3.0" >> $GITHUB_STEP_SUMMARY

  # ๐ ุงููุดุฑ ุงูุชููุงุฆู
  deploy:
    name: ๐ ุงููุดุฑ ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: [background-agent, comprehensive-tests]
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐๏ธ ุจูุงุก ุงููุดุฑูุน
        run: npm run build

      - name: ๐ ุงููุดุฑ
        run: |
          echo "๐ ูุดุฑ ุงููุดุฑูุน..."
          echo "โ ุชู ุงููุดุฑ ุจูุฌุงุญ ุจูุงุณุทุฉ AI Self-Healing CI/CD v3.0"

  # ๐งน ุชูุธูู
  cleanup:
    name: ๐งน ุชูุธูู
    runs-on: ubuntu-latest
    needs: [report, deploy]
    if: always()
    steps:
      - name: ๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
        run: |
          echo "๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ..."
          # ุญุฐู ุงููููุงุช ุงููุคูุชุฉ

      - name: ๐ ุชุญุฏูุซ ุงูุณุฌูุงุช
        run: |
          echo "๐ ุชุญุฏูุซ ุณุฌูุงุช ุงููุธุงู..."
          echo "โ ุชู ุชูุธูู ุงููุธุงู ุจูุฌุงุญ"
