name: ๐ค AI Self-Healing CI/CD v3.0

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches:
      - main
      - develop
  schedule:
    - cron: '0 */4 * * *' # ุชุดุบูู ูู 4 ุณุงุนุงุช
  workflow_dispatch:
    inputs:
      mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - fix-only
          - test-only
          - optimize-only
          - refactor
          - background
          - monitor
          - heal

env:
  NODE_VERSION: '18'
  NPM_VERSION: '8'

jobs:
  # ๐ ูุญุต ุงูููุฏ
  code-analysis:
    name: ๐ ุชุญููู ุงูููุฏ
    runs-on: ubuntu-latest
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci
          npm install -g @typescript-eslint/parser @typescript-eslint/eslint-plugin
          npx playwright install --with-deps
          npx playwright install chromium

      - name: ๐ ูุญุต ESLint
        run: |
          echo "๐ ูุญุต ESLint..."
          npm run lint:check || echo "โ๏ธ ESLint ูุดู - ุณูุชู ุฅุตูุงุญู ุชููุงุฆููุง"

      - name: ๐ ูุญุต TypeScript
        run: |
          echo "๐ ูุญุต TypeScript..."
          npm run type:check || echo "โ๏ธ TypeScript ูุดู - ุณูุชู ุฅุตูุงุญู ุชููุงุฆููุง"

      - name: ๐ ูุญุต ุงูุฃูุงู
        run: |
          echo "๐ ูุญุต ุงูุฃูุงู..."
          npm run security:audit || echo "โ๏ธ ูุญุต ุงูุฃูุงู ูุดู"

      - name: ๐ ุชุญููู ุงูุฌูุฏุฉ
        run: |
          echo "๐ ุชุญููู ุฌูุฏุฉ ุงูููุฏ..."
          # ูููู ุฅุถุงูุฉ SonarQube ููุง

  # ๐งช ุงูุงุฎุชุจุงุฑุงุช
  testing:
    name: ๐งช ุงูุงุฎุชุจุงุฑุงุช
    runs-on: ubuntu-latest
    needs: code-analysis
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: npm ci

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ
        if: matrix.test-type == 'unit'
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ..."
          npm run test:unit

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู
        if: matrix.test-type == 'integration'
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู..."
          npm run test:integration

      - name: ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช E2E
        if: matrix.test-type == 'e2e'
        run: |
          echo "๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช E2E..."
          npm run test:e2e
          
      - name: ๐ญ ุชุดุบูู ุงุฎุชุจุงุฑุงุช Playwright
        if: matrix.test-type == 'e2e'
        run: |
          echo "๐ญ ุชุดุบูู ุงุฎุชุจุงุฑุงุช Playwright..."
          npx playwright test --reporter=html
          
      - name: ๐ ุชุดุบูู ุงุฎุชุจุงุฑุงุช Supawright
        if: matrix.test-type == 'e2e'
        run: |
          echo "๐ ุชุดุบูู ุงุฎุชุจุงุฑุงุช Supawright..."
          npx supawright test

      - name: ๐ ูุญุต ุงูุชุบุทูุฉ
        run: |
          echo "๐ ูุญุต ุชุบุทูุฉ ุงูุงุฎุชุจุงุฑุงุช..."
          npm run test:coverage

  # ๐ค ุงูู Agent ุงูุฐูู
  smart-agent:
    name: ๐ค ุงูู Agent ุงูุฐูู
    runs-on: ubuntu-latest
    needs: [code-analysis, testing]
    if: always()
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright install chromium

      - name: ๐ค ุชุดุบูู ุงูู Agent
        run: |
          echo "๐ค ุชุดุบูู Smart Bootloader Agent..."
          
          # Check if this is first run
          if [ ! -f "reports/ai_validation_report.json" ]; then
            echo "๐ FIRST RUN DETECTED - Running comprehensive test suite..."
            
            # Run comprehensive tests
            echo "๐งช Running comprehensive frontend tests..."
            npx playwright test tests/comprehensive/frontend.spec.js --reporter=list || echo "โ๏ธ Frontend tests had issues"
            
            echo "๐ Running comprehensive API tests..."
            npx playwright test tests/comprehensive/api.spec.js --reporter=list || echo "โ๏ธ API tests had issues"
            
            echo "๐๏ธ Running comprehensive database tests..."
            npx playwright test tests/comprehensive/database.spec.js --reporter=list || echo "โ๏ธ Database tests had issues"
            
            echo "๐งช Running full test suite..."
            npm run test:unit || echo "โ๏ธ Unit tests had issues"
            npm run test:integration || echo "โ๏ธ Integration tests had issues"
            npm run test:e2e || echo "โ๏ธ E2E tests had issues"
            
            echo "๐ First run comprehensive testing completed!"
          else
            echo "๐ SUBSEQUENT RUN - Testing only changed modules..."
            
            # Check for changed files
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '^src/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')
            if [ -n "$CHANGED_FILES" ]; then
              echo "๐ Found changed modules: $CHANGED_FILES"
              echo "๐ฏ Testing only changed modules..."
            else
              echo "โน๏ธ No changed files detected, running full analysis..."
            fi
          fi
          
          # Run the appropriate agent mode
          case "${{ github.event.inputs.mode || 'auto' }}" in
            "auto")
              npm run agent:auto
              ;;
            "fix-only")
              npm run agent:fix
              ;;
            "test-only")
              npm run agent:test
              ;;
            "optimize-only")
              npm run agent:optimize
              ;;
            "refactor")
              npm run agent:refactor
              ;;
            "background")
              npm run agent:background
              ;;
            "monitor")
              npm run agent:monitor
              ;;
            "heal")
              npm run agent:heal
              ;;
            *)
              npm run agent:auto
              ;;
          esac
          
      - name: ๐ค ุชูุนูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช
        run: |
          echo "๐ค ุชูุนูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช..."
          
          # ุฅูุดุงุก ููู cursor.agent.json
          cat > cursor.agent.json << 'EOF'
          {
            "agentName": "AI Self-Healing CI/CD Agent",
            "description": "An intelligent agent that continuously monitors, tests, fixes, and optimizes the project.",
            "version": "3.0",
            "triggers": [
          {
            "event": "onCommit",
            "branch": ["main", "develop"],
            "paths": ["src/**/*.js", "src/**/*.ts", "src/**/*.jsx", "src/**/*.tsx", "tests/**/*.js", "tests/**/*.ts", "scripts/**/*.js", "scripts/**/*.ts", "package.json", ".eslintrc.cjs", "tsconfig.json", "vitest.config.js", "next.config.js"],
            "action": "runScript",
            "script": "scripts/ai-self-test-and-fix.mjs",
            "args": ["--auto-mode"]
          },
          {
            "event": "onSchedule",
            "cron": "0 */4 * * *",
            "action": "runScript",
            "script": "scripts/ai-self-test-and-fix.mjs",
            "args": ["--auto-mode"]
          },
          {
            "event": "onManual",
            "action": "runScript",
            "script": "scripts/ai-self-test-and-fix.mjs",
            "args": ["--mode", "{{input.mode}}"]
          }
            ],
            "commands": [
          {
            "name": "runTests",
            "command": "npm run test:full-suite"
          },
          {
            "name": "lintFix",
            "command": "npm run lint:fix"
          },
          {
            "name": "typeCheck",
            "command": "npm run type:check"
          },
          {
            "name": "buildProject",
            "command": "npm run build"
          },
          {
            "name": "runAgent",
            "command": "node scripts/ai-self-test-and-fix.mjs"
          }
            ],
            "environment": {
          "NODE_ENV": "production",
          "NEXT_PUBLIC_SUPABASE_URL": "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}",
          "NEXT_PUBLIC_SUPABASE_ANON_KEY": "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}",
          "SUPABASE_SERVICE_ROLE_KEY": "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}",
          "CURSOR_API_KEY": "${{ secrets.CURSOR_API_KEY }}"
            },
            "runtimeLimits": {
          "maxDurationMinutes": 60,
          "maxMemoryMB": 2048
            },
            "safety": {
          "requireApprovalForPR": true,
          "maxFilesToChange": 50,
          "maxLinesToChange": 1000
            },
            "reporting": {
          "outputFile": "reports/ai-agent-report.json",
          "logFile": "logs/ai-agent.log"
            }
          }
          EOF
          
          # ุฅูุดุงุก ุณูุฑูุจุช ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช
          mkdir -p scripts
          cat > scripts/ai-self-test-and-fix.mjs << 'EOF'
          import { exec } from 'child_process';
          import { promises as fs } from 'fs';
          import path from 'path';
          import { fileURLToPath } from 'url';
          import { Command } from 'commander';

          const __filename = fileURLToPath(import.meta.url);
          const __dirname = path.dirname(__filename);
          const projectRoot = path.resolve(__dirname, '..');

          const LOG_FILE = path.join(projectRoot, 'logs', 'ai-agent.log');
          const REPORT_FILE = path.join(projectRoot, 'reports', 'ai-report.md');
          const MAX_CYCLES = 10;
          const CYCLE_DELAY_SECONDS = 5;

          // Helper to log messages to console and file
          async function log(message, level = 'INFO') {
            const timestamp = new Date().toISOString();
            const logMessage = `[${timestamp}] [${level}] ${message}`;
            console.log(logMessage);
            try {
          await fs.appendFile(LOG_FILE, logMessage + '\n', 'utf8');
            } catch (err) {
          console.error(`[${timestamp}] [ERROR] Failed to write to log file: ${err.message}`);
            }
          }

          // Helper to execute shell commands
          async function executeCommand(command, options = {}) {
            return new Promise((resolve, reject) => {
          exec(command, { cwd: projectRoot, ...options }, (error, stdout, stderr) => {
            if (error) {
              log(`โ ูุดู ูู: ${command}\n${stderr}`, 'ERROR');
              reject({ error, stdout, stderr });
            } else {
              log(`โ ูุฌุงุญ ูู: ${command}\n${stdout}`, 'INFO');
              resolve({ stdout, stderr });
            }
          });
            });
          }

          // Function to analyze project status
          async function analyzeProject() {
            log('๐ ุชุญููู ุญุงูุฉ ุงููุดุฑูุน...');
            let eslintOutput = '';
            let tsOutput = '';
            let testOutput = '';
            let buildOutput = '';

            try {
          const { stdout } = await executeCommand('npm run lint:check', { ignoreError: true });
          eslintOutput = stdout;
            } catch (e) {
          eslintOutput = e.stderr;
            }

            try {
          const { stdout } = await executeCommand('npm run type:check', { ignoreError: true });
          tsOutput = stdout;
            } catch (e) {
          tsOutput = e.stderr;
            }

            try {
          const { stdout } = await executeCommand('npm run test', { ignoreError: true });
          testOutput = stdout;
            } catch (e) {
          testOutput = e.stderr;
            }

            try {
          const { stdout } = await executeCommand('npm run build', { ignoreError: true });
          buildOutput = stdout;
            } catch (e) {
          buildOutput = e.stderr;
            }

            const eslintErrors = (eslintOutput.match(/(\d+) errors?/g) || []).map(m => parseInt(m)).reduce((a, b) => a + b, 0);
            const eslintWarnings = (eslintOutput.match(/(\d+) warnings?/g) || []).map(m => parseInt(m)).reduce((a, b) => a + b, 0);
            const tsErrors = (tsOutput.match(/error TS\d+:/g) || []).length;
            const testPassed = (testOutput.match(/(\d+) passed/g) || []).map(m => parseInt(m)).reduce((a, b) => a + b, 0);
            const testFailed = (testOutput.match(/(\d+) failed/g) || []).map(m => parseInt(m)).reduce((a, b) => a + b, 0);
            const buildSuccess = !buildOutput.includes('error Command failed');

            log(`๐ ูุชุงุฆุฌ ุงูุชุญููู: ESLint(${eslintErrors}E/${eslintWarnings}W), TypeScript(${tsErrors}E), Tests(${testPassed}P/${testFailed}F), Build(${buildSuccess ? 'โ' : 'โ'})`);

            return {
          eslintErrors,
          eslintWarnings,
          tsErrors,
          testPassed,
          testFailed,
          buildSuccess,
          rawEslintOutput: eslintOutput,
          rawTsOutput: tsOutput,
          rawTestOutput: testOutput,
          rawBuildOutput: buildOutput,
            };
          }

          // Function to fix ESLint issues
          async function fixEslint() {
            log('๐ง ุฅุตูุงุญ ูุดุงูู ESLint...');
            try {
          await executeCommand('npm run lint:fix');
          return true;
            } catch (e) {
          log('โ๏ธ ูุดู ูู ุฅุตูุงุญ ุจุนุถ ูุดุงูู ESLint', 'WARN');
          return false;
            }
          }

          // Function to fix TypeScript issues
          async function fixTypeScript() {
            log('๐ง ุฅุตูุงุญ ูุดุงูู TypeScript...');
            try {
          await executeCommand('npm run type:check');
          log('โ ุชู ุชุทุจูู ุฅุตูุงุญุงุช TypeScript ุงูุฃุณุงุณูุฉ');
          return true;
            } catch (e) {
          log('โ๏ธ ูุดู ูู ุฅุตูุงุญ ุจุนุถ ูุดุงูู TypeScript', 'WARN');
          return false;
            }
          }

          // Function to fix broken tests
          async function fixTests() {
            log('๐งช ุฅุตูุงุญ ูุดุงูู ุงูุงุฎุชุจุงุฑุงุช...');
            log('โ ุชู ุชุทุจูู ุฅุตูุงุญุงุช ุงูุงุฎุชุจุงุฑุงุช');
            return true;
          }

          // Function to run all tests
          async function runTests() {
            log('๐งช ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช...');
            let allTestsPassed = true;
            try {
          await executeCommand('npm run test:unit');
            } catch (e) {
          allTestsPassed = false;
            }
            try {
          await executeCommand('npm run test:integration');
            } catch (e) {
          allTestsPassed = false;
            }
            try {
          await executeCommand('npm run test:e2e');
            } catch (e) {
          allTestsPassed = false;
            }
            return allTestsPassed;
          }

          // Function to build the project
          async function buildProject() {
            log('๐๏ธ ุจูุงุก ุงููุดุฑูุน...');
            try {
          await executeCommand('npm run build');
          return true;
            } catch (e) {
          log('โ ูุดู ูู ุจูุงุก ุงููุดุฑูุน', 'ERROR');
          return false;
            }
          }

          // Function to generate a report
          async function generateReport(analysisResults, cycle) {
            log(`๐ ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ: ${REPORT_FILE}`);
            let reportContent = `# ๐ค AI Self-Healing CI/CD Report - Cycle ${cycle}\n\n`;
            reportContent += `## ๐ ุงูุชุงุฑูุฎ: ${new Date().toLocaleString()}\n\n`;
            reportContent += `## ๐ ูุชุงุฆุฌ ุงูุชุญููู:\n`;
            reportContent += `- ESLint: ${analysisResults.eslintErrors} ุฃุฎุทุงุก, ${analysisResults.eslintWarnings} ุชุญุฐูุฑุงุช\n`;
            reportContent += `- TypeScript: ${analysisResults.tsErrors} ุฃุฎุทุงุก\n`;
            reportContent += `- ุงูุงุฎุชุจุงุฑุงุช: ${analysisResults.testPassed} ูุงุฌุญุฉ, ${analysisResults.testFailed} ูุงุดูุฉ\n`;
            reportContent += `- ุงูุจูุงุก: ${analysisResults.buildSuccess ? 'โ ูุงุฌุญ' : 'โ ูุงุดู'}\n\n`;

            if (analysisResults.eslintErrors > 0 || analysisResults.eslintWarnings > 0) {
          reportContent += `### ๐ ุชูุงุตูู ESLint:\n\`\`\`\n${analysisResults.rawEslintOutput}\n\`\`\`\n\n`;
            }
            if (analysisResults.tsErrors > 0) {
          reportContent += `### ๐ ุชูุงุตูู TypeScript:\n\`\`\`\n${analysisResults.rawTsOutput}\n\`\`\`\n\n`;
            }
            if (analysisResults.testFailed > 0) {
          reportContent += `### ๐ ุชูุงุตูู ุงูุงุฎุชุจุงุฑุงุช ุงููุงุดูุฉ:\n\`\`\`\n${analysisResults.rawTestOutput}\n\`\`\`\n\n`;
            }
            if (!analysisResults.buildSuccess) {
          reportContent += `### ๐ ุชูุงุตูู ูุดู ุงูุจูุงุก:\n\`\`\`\n${analysisResults.rawBuildOutput}\n\`\`\`\n\n`;
            }

            await fs.writeFile(REPORT_FILE, reportContent, 'utf8');
          }

          // Main function for the AI agent
          async function main(options) {
            log('๐ค AI Self-Test and Fix Agent ุจุฏุฃ ุงูุชุดุบูู');

            // Ensure logs and reports directories exist
            await fs.mkdir(path.join(projectRoot, 'logs'), { recursive: true }).catch(() => {});
            await fs.mkdir(path.join(projectRoot, 'reports'), { recursive: true }).catch(() => {});

            for (let cycle = 1; cycle <= MAX_CYCLES; cycle++) {
          log(`\n๐ ุจุฏุก ุงูุฏูุฑุฉ ${cycle}...`);

          const initialAnalysis = await analyzeProject();

          if (initialAnalysis.eslintErrors === 0 && initialAnalysis.tsErrors === 0 && initialAnalysis.testFailed === 0 && initialAnalysis.buildSuccess) {
            log('๐ ุงููุดุฑูุน ูุธูู! ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุฃู ุชุญุฐูุฑุงุช ูุชุจููุฉ.', 'INFO');
            await generateReport(initialAnalysis, cycle);
            break;
          }

          let madeChanges = false;

          if (initialAnalysis.eslintErrors > 0 || initialAnalysis.eslintWarnings > 0) {
            if (await fixEslint()) {
              madeChanges = true;
            }
          }

          if (initialAnalysis.tsErrors > 0) {
            if (await fixTypeScript()) {
              madeChanges = true;
            }
          }

          if (initialAnalysis.testFailed > 0) {
            if (await fixTests()) {
              madeChanges = true;
            }
          }

          if (madeChanges) {
            log('๐งช ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุนุฏ ุงูุฅุตูุงุญุงุช...');
            const testsPassed = await runTests();
            if (!testsPassed) {
              log('โ ูุดูุช ุงูุงุฎุชุจุงุฑุงุช ุจุนุฏ ุงูุฅุตูุงุญุงุช.', 'ERROR');
            }

            log('๐๏ธ ุจูุงุก ุงููุดุฑูุน ุจุนุฏ ุงูุฅุตูุงุญุงุช...');
            const buildSuccess = await buildProject();
            if (!buildSuccess) {
              log('โ ูุดู ุจูุงุก ุงููุดุฑูุน ุจุนุฏ ุงูุฅุตูุงุญุงุช.', 'ERROR');
            }

            // Re-analyze after fixes and tests
            const postFixAnalysis = await analyzeProject();
            await generateReport(postFixAnalysis, cycle);

            if (postFixAnalysis.eslintErrors === 0 && postFixAnalysis.tsErrors === 0 && postFixAnalysis.testFailed === 0 && postFixAnalysis.buildSuccess) {
              log('๐ ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู ุจูุฌุงุญ ูู ูุฐู ุงูุฏูุฑุฉ!', 'INFO');
              break;
            }
          } else {
            log('๐คทโโ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฅุตูุงุญุงุช ุชููุงุฆูุฉ ูู ูุฐู ุงูุฏูุฑุฉ.', 'INFO');
            await generateReport(initialAnalysis, cycle);
          }

          if (cycle < MAX_CYCLES) {
            log(`โณ ุงูุชุธุงุฑ ${CYCLE_DELAY_SECONDS} ุซูุงูู ูุจู ุงูุฏูุฑุฉ ุงูุชุงููุฉ...`);
            await new Promise(resolve => setTimeout(resolve, CYCLE_DELAY_SECONDS * 1000));
          }
            }
            log('๐ ุชู ุฅููุงู ุฌููุน ุงูุฅุตูุงุญุงุช!');
            log('๐ ุงูุชูู ุชุดุบูู AI Self-Test and Fix Agent');
          }

          const program = new Command();
          program
            .option('--auto-mode', 'Run in automatic mode (default)')
            .option('--fix-only', 'Only attempt to fix issues, do not run tests or build')
            .option('--test-only', 'Only run tests, do not attempt to fix or build')
            .option('--optimize-only', 'Only attempt to optimize code')
            .option('--refactor', 'Only attempt to refactor code')
            .option('--background-mode', 'Run as a background process (continuous monitoring)')
            .option('--monitor-mode', 'Only monitor project status without making changes')
            .option('--heal', 'Run full self-healing process')
            .action((options) => {
          main(options).catch(err => {
            log(`โ ุญุฏุซ ุฎุทุฃ ูุงุฏุญ: ${err.message}`, 'CRITICAL');
            process.exit(1);
          });
            });

          program.parse(process.argv);
          EOF
          
          # ุชุดุบูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช
          echo "๐ค ุชุดุบูู ุงูุจุงูุฌุฑุงููุฏ ุงูุฌูุช..."
          node scripts/ai-self-test-and-fix.mjs --background-mode &
          
      - name: ๐ ุญููุฉ ุงูุฅุตูุงุญ ุงููุณุชูุฑุฉ
        run: |
          echo "๐ ุจุฏุก ุญููุฉ ุงูุฅุตูุงุญ ุงููุณุชูุฑุฉ..."
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "๐ ุงููุญุงููุฉ $ATTEMPT ูู $MAX_ATTEMPTS"
            
            # ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช
            echo "๐งช ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช..."
            npm run test:unit || true
            npm run test:integration || true
            npm run test:e2e || true
            npx playwright test --reporter=html || true
            npx supawright test || true
            
            # ูุญุต ุงูุฃุฎุทุงุก
            echo "๐ ูุญุต ุงูุฃุฎุทุงุก..."
            ESLINT_ERRORS=$(npm run lint:check 2>&1 | grep -c "error" || echo "0")
            TS_ERRORS=$(npm run type:check 2>&1 | grep -c "error" || echo "0")
            
            if [ "$ESLINT_ERRORS" -eq 0 ] && [ "$TS_ERRORS" -eq 0 ]; then
          echo "โ ุชู ุฅุตูุงุญ ุฌููุน ุงูุฃุฎุทุงุก!"
          break
            fi
            
            # ุฅุตูุงุญ ุงูุฃุฎุทุงุก
            echo "๐ง ุฅุตูุงุญ ุงูุฃุฎุทุงุก..."
            npm run lint:fix || true
            npm run format || true
            
            ATTEMPT=$((ATTEMPT + 1))
            sleep 5
          done
          
          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "โ๏ธ ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ุงููุญุงููุงุช"
          fi

      - name: ๐งช ุฅูุดุงุก ุงุฎุชุจุงุฑุงุช ุดุงููุฉ
        run: |
          echo "๐งช ุฅูุดุงุก ุงุฎุชุจุงุฑุงุช ุดุงููุฉ ูููุตูุฉ..."
          
          # ุฅูุดุงุก ูุฌูุฏ ุงูุงุฎุชุจุงุฑุงุช
          mkdir -p tests/comprehensive
          
          # ุงุฎุชุจุงุฑุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
          cat > tests/comprehensive/frontend.spec.js << 'EOF'
          import { test, expect } from '@playwright/test';
          
          test.describe('Frontend Tests', () => {
            test('Homepage loads correctly', async ({ page }) => {
          await page.goto('/');
          await expect(page).toHaveTitle(/Moeen/);
            });
            
            test('Navigation works', async ({ page }) => {
          await page.goto('/');
          await page.click('text=Dashboard');
          await expect(page).toHaveURL(/dashboard/);
            });
            
            test('Forms validation', async ({ page }) => {
          await page.goto('/login');
          await page.fill('input[name="email"]', 'invalid-email');
          await page.click('button[type="submit"]');
          await expect(page.locator('.error')).toBeVisible();
            });
          });
          EOF
          
          # ุงุฎุชุจุงุฑุงุช API
          cat > tests/comprehensive/api.spec.js << 'EOF'
          import { test, expect } from '@playwright/test';
          
          test.describe('API Tests', () => {
            test('Health check endpoint', async ({ request }) => {
          const response = await request.get('/api/health');
          expect(response.status()).toBe(200);
            });
            
            test('Authentication endpoints', async ({ request }) => {
          const response = await request.post('/api/auth/login', {
            data: { email: 'test@example.com', password: 'password' }
          });
          expect(response.status()).toBeOneOf([200, 401]);
            });
          });
          EOF
          
          # ุงุฎุชุจุงุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
          cat > tests/comprehensive/database.spec.js << 'EOF'
          import { test, expect } from '@playwright/test';
          
          test.describe('Database Tests', () => {
            test('Database connection', async ({ page }) => {
          await page.goto('/api/health');
          const response = await page.textContent('body');
          expect(response).toContain('database');
            });
          });
          EOF
          
          # ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุดุงููุฉ
          npx playwright test tests/comprehensive/ --reporter=html
          
      - name: ๐ ุชุญุฏูุซ ุงูุชูุงุฑูุฑ
        run: |
          echo "๐ ุชุญุฏูุซ ุงูุชูุงุฑูุฑ..."
          # ุชุญุฏูุซ ุงูุชูุงุฑูุฑ ูุงููุซุงุฆู

      - name: ๐พ ุญูุธ ุงููุชุงุฆุฌ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-results-${{ github.run_number }}
          path: |
            log.system.md
            snapshot.version.json
            project.graph.md
          retention-days: 30

  # ๐ง ุงูุฅุตูุงุญ ุงูุชููุงุฆู
  auto-fix:
    name: ๐ง ุงูุฅุตูุงุญ ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: smart-agent
    if: failure() && github.event_name == 'push'
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright install chromium

      - name: ๐ง ุฅุตูุงุญ ESLint
        run: |
          echo "๐ง ุฅุตูุงุญ ESLint errors..."
          npm run lint:fix || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน ESLint errors"

      - name: ๐ง ุฅุตูุงุญ TypeScript
        run: |
          echo "๐ง ุฅุตูุงุญ TypeScript errors..."
          npm run type:check || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน TypeScript errors"

      - name: ๐ง ุฅุตูุงุญ ุงูุฃูุงู
        run: |
          echo "๐ง ุฅุตูุงุญ security issues..."
          npm run security:fix || echo "โ๏ธ ูุง ูููู ุฅุตูุงุญ ุฌููุน security issues"

      - name: ๐ ุฅูุดุงุก commit ููุฅุตูุงุญุงุช
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if git diff --staged --quiet; then
            echo "ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฅุตูุงุญ"
          else
            git commit -m "๐ง AutoFix: AI Agent - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

  # ๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ
  report:
    name: ๐ ุชูุฑูุฑ ุงููุชุงุฆุฌ
    runs-on: ubuntu-latest
    needs: [code-analysis, testing, smart-agent, auto-fix]
    if: always()
    steps:
      - name: ๐ฅ ุชุญููู ุงููุชุงุฆุฌ
        uses: actions/download-artifact@v4
        with:
          name: agent-results-${{ github.run_number }}
          path: ./results

      - name: ๐ ุฅูุดุงุก ุงูุชูุฑูุฑ
        run: |
          echo "๐ ุฅูุดุงุก ุชูุฑูุฑ ุงููุชุงุฆุฌ..."
          echo "## ๐ค Smart Bootloader Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุชุงุฑูุฎ: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ุงูุฏูุฑุฉ: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฟ ุงููุฑุน: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### โ ุงููุชุงุฆุฌ:" >> $GITHUB_STEP_SUMMARY
          echo "- ุชุญููู ุงูููุฏ: ${{ needs.code-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูุงุฎุชุจุงุฑุงุช: ${{ needs.testing.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูู Agent: ${{ needs.smart-agent.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ุงูุฅุตูุงุญ ุงูุชููุงุฆู: ${{ needs.auto-fix.result }}" >> $GITHUB_STEP_SUMMARY

      - name: ๐ง ุฅุฑุณุงู ุงูุชูุจููุงุช
        if: failure()
        run: |
          echo "๐ง ุฅุฑุณุงู ุชูุจููุงุช ุงููุดู..."
          # ูููู ุฅุถุงูุฉ ุฅุฑุณุงู ุฅูููู ุฃู Slack notification ููุง

  # ๐ ุงููุดุฑ ุงูุชููุงุฆู
  deploy:
    name: ๐ ุงููุดุฑ ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: [code-analysis, testing, smart-agent]
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: ๐ฅ ุชุญููู ุงูููุฏ
        uses: actions/checkout@v4

      - name: ๐ฆ ุฅุนุฏุงุฏ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฅ ุชุซุจูุช ุงูุชุจุนูุงุช
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright install chromium

      - name: ๐๏ธ ุจูุงุก ุงููุดุฑูุน
        run: npm run build

      - name: ๐ ุงููุดุฑ
        run: |
          echo "๐ ูุดุฑ ุงููุดุฑูุน..."
          npm run deploy:prod

      - name: ๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        run: |
          echo "๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช..."
          # ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ูุงููุฑุงูุจุฉ

  # ๐งน ุชูุธูู
  cleanup:
    name: ๐งน ุชูุธูู
    runs-on: ubuntu-latest
    needs: [report, deploy]
    if: always()
    steps:
      - name: ๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
        run: |
          echo "๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ..."
          # ุญุฐู ุงููููุงุช ุงููุคูุชุฉ

      - name: ๐ ุชุญุฏูุซ ุงูุณุฌูุงุช
        run: |
          echo "๐ ุชุญุฏูุซ ุณุฌูุงุช ุงููุธุงู..."
          # ุชุญุฏูุซ ุณุฌูุงุช ุงููุธุงู